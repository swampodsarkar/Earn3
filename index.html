<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskEarn - Telegram WebApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Telegram-like animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Fixed layout for Telegram WebApp */
        body {
            overflow: hidden;
            height: 100vh;
        }
        
        /* Custom scrollbar */
        .scrollable {
            scrollbar-width: thin;
            scrollbar-color: #6366f1 #f1f1f1;
        }
        
        .scrollable::-webkit-scrollbar {
            width: 4px;
        }
        
        .scrollable::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .scrollable::-webkit-scrollbar-thumb {
            background-color: #6366f1;
            border-radius: 2px;
        }
        
        /* Button press effect */
        .btn-press:active {
            transform: scale(0.96);
        }
        
        /* Fixed height sections */
        .fixed-section {
            height: calc(100vh - 56px);
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans relative h-screen overflow-hidden">

<!-- Loading Screen -->
<div id="loadingScreen" class="h-screen flex flex-col items-center justify-center text-lg font-bold bg-indigo-600 text-white">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div>
    <p>Connecting to Telegram...</p>
</div>

<!-- Main App Container -->
<div id="appContainer" class="h-full flex flex-col hidden">
    <!-- Header -->
    <div class="bg-indigo-600 text-white p-4 flex justify-between items-center shadow-md">
        <div>
            <h2 id="displayName" class="font-bold text-lg flex items-center">
                <i class="fas fa-user-circle mr-2"></i>
                <span>User</span>
            </h2>
            <p id="balanceDisplay" class="text-sm opacity-90">
                <i class="fas fa-coins mr-1"></i> Balance: 0 Coins
            </p>
        </div>
        <div class="flex items-center space-x-2">
            <button onclick="showWithdrawModal()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-lg flex items-center transition-all btn-press">
                <i class="fas fa-wallet mr-1"></i> Withdraw
            </button>
        </div>
    </div>

    <!-- Notification Banner -->
    <div id="notificationBanner" class="hidden bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-3">
        <div class="flex justify-between items-center">
            <p id="notificationText"></p>
            <button onclick="hideNotification()" class="text-blue-700 transition-all hover:scale-110">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Main Content - Fixed Height with Scroll -->
    <div id="mainContent" class="fixed-section">
        <!-- Balance Card -->
        <div class="bg-white mx-4 mt-4 p-4 rounded-lg shadow-md transition-all hover:shadow-lg animate-fadeIn">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-gray-500 text-sm">Total Balance</h3>
                    <p id="mainBalance" class="text-2xl font-bold">0 Coins</p>
                    <p class="text-sm text-gray-500 mt-1">100 Coins = 10 Taka</p>
                </div>
                <div class="bg-indigo-100 p-3 rounded-full transition-all hover:bg-indigo-200">
                    <i class="fas fa-coins text-indigo-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-2 gap-3 mx-4 mt-4">
            <div class="bg-white p-3 rounded-lg shadow-sm transition-all hover:shadow-md animate-fadeIn">
                <p class="text-gray-500 text-xs">Today's Earnings</p>
                <p id="todayEarnings" class="font-bold">0 Coins</p>
            </div>
            <div class="bg-white p-3 rounded-lg shadow-sm transition-all hover:shadow-md animate-fadeIn">
                <p class="text-gray-500 text-xs">Total Earnings</p>
                <p id="totalEarningsMini" class="font-bold">0 Coins</p>
            </div>
        </div>

        <!-- Referral Section -->
        <div class="mx-4 mt-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-lg shadow-md animate-fadeIn">
            <h3 class="font-bold mb-2 flex items-center">
                <i class="fas fa-user-plus mr-2"></i> Refer & Earn
            </h3>
            <p class="text-sm mb-3">Invite friends and earn 5% of their earnings!</p>
            <div class="flex items-center bg-black bg-opacity-20 p-2 rounded">
                <input type="text" id="referralLink" class="flex-1 bg-transparent border-none text-white" value="https://t.me/earnTo3_bot" readonly>
                <button onclick="copyReferralLink()" class="ml-2 bg-white text-emerald-600 px-3 py-1 rounded text-sm font-bold transition-all hover:bg-gray-100 btn-press">
                    <i class="fas fa-copy mr-1"></i> Copy
                </button>
            </div>
        </div>

        <!-- Daily Reward Section -->
        <div class="mx-4 mt-4 animate-fadeIn">
            <button onclick="claimDaily()" id="dailyButton" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all btn-press">
                <i class="fas fa-gift mr-2"></i> Claim Daily Reward (10 Coins)
            </button>
        </div>

        <!-- Task List -->
        <div class="mx-4 mt-6 mb-4">
            <h3 class="font-bold text-xl mb-3 flex items-center animate-fadeIn">
                <i class="fas fa-tasks mr-2 text-indigo-600"></i> Available Tasks
            </h3>
            <div id="tasksContainer" class="space-y-3"></div>
            
            <!-- Empty State -->
            <div id="emptyTasks" class="text-center py-8 text-gray-500 hidden">
                <i class="fas fa-tasks text-4xl mb-3 opacity-30"></i>
                <p>No tasks available at the moment</p>
                <p class="text-sm mt-2">Check back later for new tasks</p>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Nav -->
    <div class="bg-white border-t border-gray-200 p-3 flex justify-around fixed bottom-0 left-0 right-0">
        <button onclick="showTaskSection()" id="navTasks" class="flex flex-col items-center text-indigo-600 transition-all hover:scale-105 btn-press">
            <i class="fas fa-tasks text-xl"></i>
            <span class="text-xs mt-1">Tasks</span>
        </button>
        <button onclick="showHistorySection()" id="navHistory" class="flex flex-col items-center text-gray-500 transition-all hover:scale-105 btn-press">
            <i class="fas fa-history text-xl"></i>
            <span class="text-xs mt-1">History</span>
        </button>
        <button onclick="showProfileSection()" id="navProfile" class="flex flex-col items-center text-gray-500 transition-all hover:scale-105 btn-press">
            <i class="fas fa-user text-xl"></i>
            <span class="text-xs mt-1">Profile</span>
        </button>
    </div>
</div>

<!-- Withdraw Modal -->
<div id="withdrawModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Withdraw Coins</h3>
            <button onclick="hideWithdrawModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Amount (Min 100 Coins = 10 Taka)</label>
            <input type="number" id="withdrawAmount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter amount">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Withdrawal Method</label>
            <select id="withdrawMethod" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                <option value="nagad">Nagad</option>
                <option value="bkash">bKash</option>
                <option value="rocket">Rocket</option>
                <option value="binance">Binance</option>
                <option value="bitget">Bitget</option>
            </select>
        </div>
        <div id="accountNumberField" class="mb-4">
            <label class="block text-gray-700 mb-2">Account Number</label>
            <input type="text" id="withdrawAccount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter account number">
        </div>
        <button onclick="submitWithdraw()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold transition-all btn-press">
            Submit Withdraw Request
        </button>
    </div>
</div>

<!-- History Section (Hidden by default) -->
<div id="historySection" class="h-full flex flex-col hidden">
    <div class="bg-indigo-600 text-white p-4 flex justify-between items-center shadow-md">
        <button onclick="showTaskSection()" class="flex items-center transition-all hover:scale-105 btn-press">
            <i class="fas fa-arrow-left mr-2"></i> Back
        </button>
        <h2 class="font-bold text-lg">Task History</h2>
        <div class="w-6"></div> <!-- Spacer for alignment -->
    </div>
    
    <div class="fixed-section p-4">
        <div id="historyContainer" class="space-y-3">
            <!-- History items will be loaded here -->
        </div>
        
        <!-- Empty State -->
        <div id="emptyHistory" class="text-center py-8 text-gray-500 hidden">
            <i class="fas fa-history text-4xl mb-3 opacity-30"></i>
            <p>No task history yet</p>
            <p class="text-sm mt-2">Complete tasks to see them here</p>
        </div>
    </div>
</div>

<!-- Profile Section (Hidden by default) -->
<div id="profileSection" class="h-full flex flex-col hidden">
    <div class="bg-indigo-600 text-white p-4 flex justify-between items-center shadow-md">
        <button onclick="showTaskSection()" class="flex items-center transition-all hover:scale-105 btn-press">
            <i class="fas fa-arrow-left mr-2"></i> Back
        </button>
        <h2 class="font-bold text-lg">My Profile</h2>
        <div class="w-6"></div> <!-- Spacer for alignment -->
    </div>
    
    <div class="fixed-section p-4">
        <div class="bg-white rounded-lg shadow-md p-4 mb-4 transition-all hover:shadow-lg animate-fadeIn">
            <div class="flex items-center space-x-4 mb-4">
                <div class="bg-indigo-100 p-3 rounded-full transition-all hover:bg-indigo-200">
                    <i class="fas fa-user text-indigo-600 text-2xl"></i>
                </div>
                <div>
                    <h3 id="profileUsername" class="font-bold text-lg">@username</h3>
                    <p id="joinDate" class="text-gray-600 text-sm">Joined 2 days ago</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Total Earned</p>
                    <p id="totalEarned" class="font-bold">0 Coins</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Withdrawn</p>
                    <p id="totalWithdrawn" class="font-bold">0 Coins</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Referral Earnings</p>
                    <p id="referralEarnings" class="font-bold">0 Coins</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Referrals</p>
                    <p id="referralCount" class="font-bold">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-4 transition-all hover:shadow-lg animate-fadeIn">
            <h3 class="font-bold mb-3">Account Information</h3>
            <div class="space-y-3">
                <div>
                    <p class="text-gray-500 text-sm">Status</p>
                    <p id="accountStatus" class="font-medium text-green-600">Active</p>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Balance Conversion</p>
                    <p class="font-medium">100 Coins = 10 Taka</p>
                </div>
            </div>
        </div>
        
        <!-- Logout Button -->
        <div class="mt-6 mb-4">
            <button onclick="logoutUser()" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold transition-all btn-press">
                <i class="fas fa-sign-out-alt mr-2"></i> Logout
            </button>
        </div>
    </div>
</div>

<!-- Admin Panel (Hidden by default) -->
<div id="adminPanel" class="h-full flex flex-col hidden">
    <div class="bg-indigo-600 text-white p-4 flex justify-between items-center shadow-md">
        <button onclick="showTaskSection()" class="flex items-center transition-all hover:scale-105 btn-press">
            <i class="fas fa-arrow-left mr-2"></i> Back
        </button>
        <h2 class="font-bold text-lg">Admin Panel</h2>
        <div class="w-6"></div> <!-- Spacer for alignment -->
    </div>
    
    <div class="fixed-section p-4">
        <div class="bg-white rounded-lg shadow-md p-4 mb-4 transition-all hover:shadow-lg animate-fadeIn">
            <h3 class="font-bold mb-3">Admin Actions</h3>
            <div class="space-y-3">
                <button onclick="showAddTaskModal()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium transition-all btn-press">
                    <i class="fas fa-plus-circle mr-2"></i> Add New Task
                </button>
                <button onclick="showManageUsersModal()" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-medium transition-all btn-press">
                    <i class="fas fa-users-cog mr-2"></i> Manage Users
                </button>
                <button onclick="showPendingSubmissions()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg font-medium transition-all btn-press">
                    <i class="fas fa-tasks mr-2"></i> Pending Submissions
                </button>
                <button onclick="showWithdrawRequests()" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg font-medium transition-all btn-press">
                    <i class="fas fa-money-bill-wave mr-2"></i> Withdraw Requests
                </button>
                <button onclick="showSendNoticeModal()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-medium transition-all btn-press">
                    <i class="fas fa-bullhorn mr-2"></i> Send Global Notice
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-4 transition-all hover:shadow-lg animate-fadeIn">
            <h3 class="font-bold mb-3">Quick Stats</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Total Users</p>
                    <p id="totalUsers" class="font-bold">0</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Active Tasks</p>
                    <p id="activeTasks" class="font-bold">0</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Pending Submissions</p>
                    <p id="pendingSubmissions" class="font-bold">0</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Withdraw Requests</p>
                    <p id="pendingWithdrawals" class="font-bold">0</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Add New Task</h3>
            <button onclick="hideAddTaskModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Task Title</label>
            <input type="text" id="taskTitle" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter task title">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Task Description</label>
            <textarea id="taskDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter task description"></textarea>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Reward (Coins)</label>
            <input type="number" id="taskReward" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter coin reward">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Task Link (Optional)</label>
            <input type="url" id="taskLink" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter task URL">
        </div>
        <div class="mb-4">
            <label class="flex items-center">
                <input type="checkbox" id="taskActive" class="rounded text-indigo-600 focus:ring-indigo-500" checked>
                <span class="ml-2 text-gray-700">Active Task</span>
            </label>
        </div>
        <button onclick="addNewTask()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold transition-all btn-press">
            Add Task
        </button>
    </div>
</div>

<!-- Manage Users Modal -->
<div id="manageUsersModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Manage Users</h3>
            <button onclick="hideManageUsersModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Search User</label>
            <input type="text" id="userSearch" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter username">
        </div>
        <div id="userSearchResults" class="max-h-60 overflow-y-auto mb-4 space-y-2 hidden">
            <!-- Search results will appear here -->
        </div>
        <div id="selectedUserInfo" class="hidden mb-4 p-3 bg-gray-50 rounded-lg">
            <h4 class="font-bold mb-2" id="selectedUsername"></h4>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div>
                    <p class="text-gray-500">Balance</p>
                    <p id="selectedUserBalance"></p>
                </div>
                <div>
                    <p class="text-gray-500">Status</p>
                    <p id="selectedUserStatus"></p>
                </div>
                <div>
                    <p class="text-gray-500">Joined</p>
                    <p id="selectedUserJoined"></p>
                </div>
                <div>
                    <p class="text-gray-500">Earned</p>
                    <p id="selectedUserEarned"></p>
                </div>
            </div>
            <div class="mt-3 flex space-x-2">
                <button onclick="banSelectedUser()" id="banUserBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-1 rounded text-sm transition-all btn-press">
                    Ban User
                </button>
                <button onclick="unbanSelectedUser()" id="unbanUserBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-1 rounded text-sm transition-all btn-press hidden">
                    Unban User
                </button>
                <button onclick="adjustUserBalance()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-1 rounded text-sm transition-all btn-press">
                    Adjust Balance
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Pending Submissions Modal -->
<div id="pendingSubmissionsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Pending Submissions</h3>
            <button onclick="hidePendingSubmissionsModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="submissionsList" class="max-h-96 overflow-y-auto space-y-3">
            <!-- Submissions will appear here -->
        </div>
    </div>
</div>

<!-- Withdraw Requests Modal -->
<div id="withdrawRequestsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Withdraw Requests</h3>
            <button onclick="hideWithdrawRequestsModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="withdrawRequestsList" class="max-h-96 overflow-y-auto space-y-3">
            <!-- Withdraw requests will appear here -->
        </div>
    </div>
</div>

<!-- Send Notice Modal -->
<div id="sendNoticeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Send Global Notice</h3>
            <button onclick="hideSendNoticeModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Notice Message</label>
            <textarea id="noticeMessage" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter your message"></textarea>
        </div>
        <button onclick="sendGlobalNotice()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold transition-all btn-press">
            Send Notice
        </button>
    </div>
</div>

<!-- Adjust Balance Modal -->
<div id="adjustBalanceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Adjust Balance</h3>
            <button onclick="hideAdjustBalanceModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Username</label>
            <input type="text" id="adjustBalanceUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" readonly>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Action</label>
            <select id="balanceAction" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                <option value="add">Add Coins</option>
                <option value="subtract">Subtract Coins</option>
                <option value="set">Set Exact Amount</option>
            </select>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Amount (Coins)</label>
            <input type="number" id="balanceAmount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter amount">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Reason (Optional)</label>
            <input type="text" id="balanceReason" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter reason">
        </div>
        <button onclick="processBalanceAdjustment()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold transition-all btn-press">
            Confirm Adjustment
        </button>
    </div>
</div>

<!-- Firebase configuration -->
<script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDX7Z8o5xVJa8cSHvaurZg4FkJvN8mJuto",
    authDomain: "free-fire-kingdom.firebaseapp.com",
    databaseURL: "https://free-fire-kingdom-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "free-fire-kingdom",
    storageBucket: "free-fire-kingdom.appspot.com",
    messagingSenderId: "889375613179",
    appId: "1:889375613179:web:b36bd72dd208b101e0d05e",
    measurementId: "G-0EWSZ3SFX1"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Telegram WebApp initialization
const tg = window.Telegram.WebApp;
tg.expand();

let currentUser = null;
let userData = {};
let tgUserData = {};
let selectedUser = null;
let adminMode = false;

// Initialize the app
function initApp() {
    const savedUser = localStorage.getItem('loggedUser');
    if (savedUser) {
        currentUser = savedUser;
        loadUser();
    } else {
        autoLoginFromTelegram();
    }
    
    // Listen for global notifications
    db.ref('notifications').limitToLast(1).on('child_added', snapshot => {
        const notification = snapshot.val();
        showNotification(notification.message);
    });
    
    // Handle withdraw method change
    document.getElementById('withdrawMethod').addEventListener('change', function() {
        const method = this.value;
        const accountField = document.getElementById('accountNumberField');
        
        if (method === 'binance' || method === 'bitget') {
            accountField.querySelector('label').textContent = 'Wallet Address';
            accountField.querySelector('input').placeholder = 'Enter wallet address';
        } else {
            accountField.querySelector('label').textContent = 'Account Number';
            accountField.querySelector('input').placeholder = 'Enter account number';
        }
    });
}

// Auto login from Telegram
function autoLoginFromTelegram() {
    const tgUser = tg.initDataUnsafe?.user;
    if (!tgUser) {
        document.getElementById('loadingScreen').innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle text-3xl text-yellow-400 mb-3"></i>
                <p class="text-lg">Please open this app from the Telegram bot</p>
                <button onclick="location.reload()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-lg transition-all hover:bg-indigo-700 btn-press">
                    <i class="fas fa-sync-alt mr-2"></i> Try Again
                </button>
            </div>
        `;
        return;
    }
    
    tgUserData = {
        id: tgUser.id,
        username: tgUser.username || ("tguser_" + tgUser.id),
        first_name: tgUser.first_name,
        last_name: tgUser.last_name
    };
    
    // Check if this is a referral signup
    const initData = new URLSearchParams(tg.initData);
    const startParam = initData.get('startapp');
    let referrer = null;
    
    if (startParam && startParam.startsWith('ref_')) {
        referrer = startParam.substring(4);
    }
    
    const userRef = db.ref('users/' + tgUserData.username);
    
    userRef.once('value', snapshot => {
        if (!snapshot.exists()) {
            // New user - check if referred
            const userData = { 
                balance: 0,
                totalEarned: 0,
                totalWithdrawn: 0,
                referralEarnings: 0,
                referralCount: 0,
                referredBy: referrer,
                lastClaim: 0,
                status: "active",
                joinedAt: Date.now(),
                tgUserId: tgUser.id,
                firstName: tgUser.first_name,
                lastName: tgUser.last_name
            };
            
            userRef.set(userData);
            
            // If referred, update referrer's data
            if (referrer) {
                db.ref('users/' + referrer).once('value', referrerSnap => {
                    if (referrerSnap.exists()) {
                        const referrerData = referrerSnap.val();
                        db.ref('users/' + referrer).update({
                            referralCount: (referrerData.referralCount || 0) + 1
                        });
                    }
                });
            }
        } else {
            // Existing user - check if banned
            const userData = snapshot.val();
            if (userData.status === "banned") {
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-ban text-3xl text-red-500 mb-3"></i>
                        <p class="text-lg">Your account has been banned</p>
                        <p class="text-sm text-gray-300 mt-2">Contact support for more information</p>
                    </div>
                `;
                return;
            }
        }
        
        // Check if admin (username swampod321)
        if (tgUserData.username === "swampod321") {
            adminMode = true;
            document.getElementById('navProfile').innerHTML = `
                <i class="fas fa-user-shield text-xl"></i>
                <span class="text-xs mt-1">Admin</span>
            `;
            document.getElementById('navProfile').onclick = showAdminPanel;
        }
        
        currentUser = tgUserData.username;
        localStorage.setItem('loggedUser', currentUser);
        loadUser();
    });
}

// Load user data
function loadUser() {
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('appContainer').classList.remove('hidden');
    showTaskSection();
    
    // Update UI with user data
    document.getElementById('displayName').textContent = tgUserData.first_name || currentUser;
    
    // Set referral link
    document.getElementById('referralLink').value = `https://t.me/earnTo3_bot?start=ref_${currentUser}`;
    
    // Listen for user data changes
    db.ref('users/' + currentUser).on('value', snapshot => {
        userData = snapshot.val() || {};
        
        // Update balance displays
        document.getElementById('balanceDisplay').innerHTML = `
            <i class="fas fa-coins mr-1"></i> Balance: ${userData.balance || 0} Coins
        `;
        document.getElementById('mainBalance').textContent = `${userData.balance || 0} Coins`;
        document.getElementById('totalEarningsMini').textContent = `${userData.totalEarned || 0} Coins`;
        
        // Calculate today's earnings (since midnight)
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayEarnings = userData.todayEarnings || {};
        let todayTotal = 0;
        
        Object.keys(todayEarnings).forEach(key => {
            if (todayEarnings[key].timestamp >= today.getTime()) {
                todayTotal += todayEarnings[key].amount || 0;
            }
        });
        
        document.getElementById('todayEarnings').textContent = `${todayTotal} Coins`;
        
        // Update profile section if visible
        if (!document.getElementById('profileSection').classList.contains('hidden')) {
            updateProfileSection();
        }
    });
    
    loadTasks();
    loadTaskHistory();
    
    // Auto approve pending tasks after 10 minutes
    checkPendingTasks();
}

// Load available tasks
function loadTasks() {
    db.ref('tasks').orderByChild('active').equalTo(true).once('value', snap => {
        const tasks = snap.val() || {};
        const container = document.getElementById('tasksContainer');
        const emptyState = document.getElementById('emptyTasks');
        
        container.innerHTML = "";
        
        if (Object.keys(tasks).length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        Object.keys(tasks).forEach(taskId => {
            const task = tasks[taskId];
            const div = document.createElement('div');
            div.className = "bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-all animate-fadeIn";
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-lg">${task.title}</h4>
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">+${task.reward} Coins</span>
                </div>
                <p class="text-gray-600 text-sm mb-3">${task.description || 'Complete this task to earn coins'}</p>
                ${task.link ? `<a href="${task.link}" target="_blank" class="text-blue-500 text-sm block mb-3"><i class="fas fa-external-link-alt mr-1"></i> Task Link</a>` : ''}
                <button onclick="submitTask('${taskId}')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-medium transition-all btn-press">
                    <i class="fas fa-check-circle mr-2"></i> Complete Task
                </button>
            `;
            container.appendChild(div);
        });
    });
}

// Submit a task for review
function submitTask(taskId) {
    const submissionId = Date.now();
    db.ref('submissions/' + submissionId).set({
        user: currentUser,
        taskId: taskId,
        status: "pending",
        submittedAt: Date.now(),
        tgUserId: tgUserData.id,
        username: currentUser
    }).then(() => {
        showNotification("Task submitted for review!");
        
        // Check if user was referred and update referrer's earnings
        if (userData.referredBy) {
            db.ref('tasks/' + taskId).once('value', taskSnap => {
                const task = taskSnap.val();
                if (task) {
                    const referralBonus = Math.floor(task.reward * 0.05); // 5% commission
                    db.ref('users/' + userData.referredBy).transaction(user => {
                        if (user) {
                            user.balance = (user.balance || 0) + referralBonus;
                            user.referralEarnings = (user.referralEarnings || 0) + referralBonus;
                            user.totalEarned = (user.totalEarned || 0) + referralBonus;
                        }
                        return user;
                    });
                }
            });
        }
    });
}

// Check for pending tasks that need auto approval
function checkPendingTasks() {
    if (!currentUser) return;
    
    db.ref('submissions').orderByChild('user').equalTo(currentUser).once('value', snap => {
        const submissions = snap.val() || {};
        const now = Date.now();
        
        Object.keys(submissions).forEach(subId => {
            const submission = submissions[subId];
            if (submission.status === "pending" && (now - submission.submittedAt) > 600000) { // 10 minutes
                // Auto approve after 10 minutes
                db.ref('submissions/' + subId).update({ status: "approved" });
                
                // Add coins to user balance
                db.ref('tasks/' + submission.taskId).once('value', taskSnap => {
                    const task = taskSnap.val();
                    if (task) {
                        db.ref('users/' + currentUser).transaction(user => {
                            if (user) {
                                user.balance = (user.balance || 0) + task.reward;
                                user.totalEarned = (user.totalEarned || 0) + task.reward;
                                
                                // Record today's earnings
                                const todayEarnings = user.todayEarnings || {};
                                todayEarnings[subId] = {
                                    amount: task.reward,
                                    timestamp: now
                                };
                                user.todayEarnings = todayEarnings;
                            }
                            return user;
                        });
                    }
                });
            }
        });
    });
}

// Load task history
function loadTaskHistory() {
    db.ref('submissions').orderByChild('user').equalTo(currentUser).limitToLast(20).once('value', snap => {
        const submissions = snap.val() || {};
        const container = document.getElementById('historyContainer');
        const emptyState = document.getElementById('emptyHistory');
        
        container.innerHTML = "";
        
        if (Object.keys(submissions).length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        // Get task names first
        db.ref('tasks').once('value', taskSnap => {
            const allTasks = taskSnap.val() || {};
            
            Object.keys(submissions).reverse().forEach(subId => {
                const submission = submissions[subId];
                const task = allTasks[submission.taskId] || { title: "Unknown Task", reward: 0 };
                
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-lg shadow-sm transition-all hover:shadow-md animate-fadeIn";
                
                let statusBadge = "";
                if (submission.status === "approved") {
                    statusBadge = `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Approved</span>`;
                } else if (submission.status === "rejected") {
                    statusBadge = `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">Rejected</span>`;
                } else {
                    statusBadge = `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Pending</span>`;
                }
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-medium">${task.title}</h4>
                        ${statusBadge}
                    </div>
                    <div class="flex justify-between text-sm text-gray-500">
                        <p>${formatDate(submission.submittedAt)}</p>
                        <p>+${task.reward || 0} Coins</p>
                    </div>
                `;
                container.appendChild(div);
            });
        });
    });
}

// Claim daily reward
function claimDaily() {
    const now = Date.now();
    const dailyButton = document.getElementById('dailyButton');
    
    // Disable button to prevent multiple clicks
    dailyButton.disabled = true;
    dailyButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Processing...`;
    
    db.ref('users/' + currentUser).once('value', snap => {
        const data = snap.val();
        const lastClaim = data.lastClaim || 0;
        const timeSinceLastClaim = now - lastClaim;
        
        if (timeSinceLastClaim < 86400000) {
            const hoursLeft = Math.floor((86400000 - timeSinceLastClaim) / 3600000);
            showNotification(`Come back in ${hoursLeft} hours to claim your next reward!`);
            dailyButton.disabled = false;
            dailyButton.innerHTML = `<i class="fas fa-clock mr-2"></i> Already Claimed Today`;
            return;
        }
        
        // Update user data
        const reward = 10; // Daily reward amount
        db.ref('users/' + currentUser).transaction(user => {
            if (user) {
                user.balance = (user.balance || 0) + reward;
                user.totalEarned = (user.totalEarned || 0) + reward;
                user.lastClaim = now;
                
                // Record today's earnings
                const todayEarnings = user.todayEarnings || {};
                todayEarnings[`daily_${now}`] = {
                    amount: reward,
                    timestamp: now
                };
                user.todayEarnings = todayEarnings;
                
                // If referred, give bonus to referrer
                if (user.referredBy) {
                    const referralBonus = Math.floor(reward * 0.05); // 5% commission
                    db.ref('users/' + user.referredBy).transaction(referrer => {
                        if (referrer) {
                            referrer.balance = (referrer.balance || 0) + referralBonus;
                            referrer.referralEarnings = (referrer.referralEarnings || 0) + referralBonus;
                            referrer.totalEarned = (referrer.totalEarned || 0) + referralBonus;
                        }
                        return referrer;
                    });
                }
            }
            return user;
        }).then(() => {
            showNotification(`Daily reward of ${reward} coins claimed!`);
            dailyButton.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Claimed Today`;
            
            // Re-enable button after 24 hours
            setTimeout(() => {
                dailyButton.disabled = false;
                dailyButton.innerHTML = `<i class="fas fa-gift mr-2"></i> Claim Daily Reward (10 Coins)`;
            }, 86400000);
        });
    });
}

// Show withdraw modal
function showWithdrawModal() {
    const minWithdraw = 100;
    if ((userData.balance || 0) < minWithdraw) {
        showNotification(`Minimum withdrawal is ${minWithdraw} coins (10 Taka)`);
        return;
    }
    
    document.getElementById('withdrawAmount').value = "";
    document.getElementById('withdrawAccount').value = "";
    document.getElementById('withdrawModal').classList.remove('hidden');
}

// Hide withdraw modal
function hideWithdrawModal() {
    document.getElementById('withdrawModal').classList.add('hidden');
}

// Submit withdraw request
function submitWithdraw() {
    const amount = parseInt(document.getElementById('withdrawAmount').value);
    const method = document.getElementById('withdrawMethod').value;
    const account = document.getElementById('withdrawAccount').value.trim();
    const minWithdraw = 100;
    
    if (!amount || amount < minWithdraw) {
        showNotification(`Minimum withdrawal is ${minWithdraw} coins (10 Taka)`);
        return;
    }
    
    if (amount > (userData.balance || 0)) {
        showNotification("Insufficient balance");
        return;
    }
    
    if (!account) {
        const fieldName = (method === 'binance' || method === 'bitget') ? 'wallet address' : 'account number';
        showNotification(`Please enter a valid ${fieldName}`);
        return;
    }
    
    const withdrawId = Date.now();
    db.ref('withdrawals/' + withdrawId).set({
        user: currentUser,
        amount: amount,
        method: method,
        account: account,
        status: "pending",
        requestedAt: Date.now(),
        tgUserId: tgUserData.id
    }).then(() => {
        // Deduct from user balance immediately
        db.ref('users/' + currentUser).update({
            balance: (userData.balance || 0) - amount,
            totalWithdrawn: (userData.totalWithdrawn || 0) + amount
        });
        
        showNotification(`Withdrawal request submitted for ${amount} coins (${amount/10} Taka)`);
        hideWithdrawModal();
        
        // Open payment method URL if available
        openPaymentMethod(method);
    });
}

// Open payment method URL
function openPaymentMethod(method) {
    let url = '';
    switch(method) {
        case 'nagad':
            url = 'https://nagad.com.bd';
            break;
        case 'bkash':
            url = 'https://www.bkash.com';
            break;
        case 'rocket':
            url = 'https://www.dutchbanglabank.com/rocket/rocket.html';
            break;
        case 'binance':
            url = 'https://www.binance.com';
            break;
        case 'bitget':
            url = 'https://www.bitget.com';
            break;
    }
    
    if (url) {
        window.open(url, '_blank');
    }
}

// Copy referral link
function copyReferralLink() {
    const linkInput = document.getElementById('referralLink');
    linkInput.select();
    document.execCommand('copy');
    
    showNotification("Referral link copied to clipboard!");
}

// Show notification
function showNotification(message) {
    const banner = document.getElementById('notificationBanner');
    document.getElementById('notificationText').textContent = message;
    banner.classList.remove('hidden');
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        banner.classList.add('hidden');
    }, 5000);
}

// Hide notification
function hideNotification() {
    document.getElementById('notificationBanner').classList.add('hidden');
}

// Show task section (main view)
function showTaskSection() {
    document.getElementById('appContainer').classList.remove('hidden');
    document.getElementById('historySection').classList.add('hidden');
    document.getElementById('profileSection').classList.add('hidden');
    document.getElementById('adminPanel').classList.add('hidden');
    
    // Update nav active state
    document.getElementById('navTasks').classList.remove('text-gray-500');
    document.getElementById('navTasks').classList.add('text-indigo-600');
    document.getElementById('navHistory').classList.remove('text-indigo-600');
    document.getElementById('navHistory').classList.add('text-gray-500');
    document.getElementById('navProfile').classList.remove('text-indigo-600');
    document.getElementById('navProfile').classList.add('text-gray-500');
}

// Show history section
function showHistorySection() {
    document.getElementById('appContainer').classList.add('hidden');
    document.getElementById('historySection').classList.remove('hidden');
    document.getElementById('profileSection').classList.add('hidden');
    document.getElementById('adminPanel').classList.add('hidden');
    loadTaskHistory();
    
    // Update nav active state
    document.getElementById('navTasks').classList.remove('text-indigo-600');
    document.getElementById('navTasks').classList.add('text-gray-500');
    document.getElementById('navHistory').classList.remove('text-gray-500');
    document.getElementById('navHistory').classList.add('text-indigo-600');
    document.getElementById('navProfile').classList.remove('text-indigo-600');
    document.getElementById('navProfile').classList.add('text-gray-500');
}

// Show profile section
function showProfileSection() {
    document.getElementById('appContainer').classList.add('hidden');
    document.getElementById('profileSection').classList.remove('hidden');
    document.getElementById('historySection').classList.add('hidden');
    document.getElementById('adminPanel').classList.add('hidden');
    updateProfileSection();
    
    // Update nav active state
    document.getElementById('navTasks').classList.remove('text-indigo-600');
    document.getElementById('navTasks').classList.add('text-gray-500');
    document.getElementById('navHistory').classList.remove('text-indigo-600');
    document.getElementById('navHistory').classList.add('text-gray-500');
    document.getElementById('navProfile').classList.remove('text-gray-500');
    document.getElementById('navProfile').classList.add('text-indigo-600');
}

// Show admin panel
function showAdminPanel() {
    document.getElementById('appContainer').classList.add('hidden');
    document.getElementById('profileSection').classList.add('hidden');
    document.getElementById('historySection').classList.add('hidden');
    document.getElementById('adminPanel').classList.remove('hidden');
    
    // Load admin stats
    loadAdminStats();
}

// Load admin stats
function loadAdminStats() {
    // Total users
    db.ref('users').once('value', snap => {
        document.getElementById('totalUsers').textContent = snap.numChildren();
    });
    
    // Active tasks
    db.ref('tasks').orderByChild('active').equalTo(true).once('value', snap => {
        document.getElementById('activeTasks').textContent = snap.numChildren();
    });
    
    // Pending submissions
    db.ref('submissions').orderByChild('status').equalTo('pending').once('value', snap => {
        document.getElementById('pendingSubmissions').textContent = snap.numChildren();
    });
    
    // Pending withdrawals
    db.ref('withdrawals').orderByChild('status').equalTo('pending').once('value', snap => {
        document.getElementById('pendingWithdrawals').textContent = snap.numChildren();
    });
}

// Show add task modal
function showAddTaskModal() {
    document.getElementById('taskTitle').value = "";
    document.getElementById('taskDescription').value = "";
    document.getElementById('taskReward').value = "";
    document.getElementById('taskLink').value = "";
    document.getElementById('taskActive').checked = true;
    document.getElementById('addTaskModal').classList.remove('hidden');
}

// Hide add task modal
function hideAddTaskModal() {
    document.getElementById('addTaskModal').classList.add('hidden');
}

// Add new task
function addNewTask() {
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const reward = parseInt(document.getElementById('taskReward').value);
    const link = document.getElementById('taskLink').value.trim();
    const active = document.getElementById('taskActive').checked;
    
    if (!title || !reward) {
        showNotification("Please fill all required fields");
        return;
    }
    
    const taskId = Date.now();
    db.ref('tasks/' + taskId).set({
        title: title,
        description: description,
        reward: reward,
        link: link,
        active: active,
        createdAt: Date.now()
    }).then(() => {
        showNotification("Task added successfully!");
        hideAddTaskModal();
    });
}

// Show manage users modal
function showManageUsersModal() {
    document.getElementById('userSearch').value = "";
    document.getElementById('userSearchResults').innerHTML = "";
    document.getElementById('userSearchResults').classList.add('hidden');
    document.getElementById('selectedUserInfo').classList.add('hidden');
    document.getElementById('manageUsersModal').classList.remove('hidden');
    
    // Add event listener for search
    document.getElementById('userSearch').addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        if (searchTerm.length < 3) {
            document.getElementById('userSearchResults').innerHTML = "";
            document.getElementById('userSearchResults').classList.add('hidden');
            return;
        }
        
        db.ref('users').once('value', snap => {
            const users = snap.val() || {};
            const results = [];
            
            Object.keys(users).forEach(username => {
                if (username.toLowerCase().includes(searchTerm)) {
                    results.push({
                        username: username,
                        data: users[username]
                    });
                }
            });
            
            const resultsContainer = document.getElementById('userSearchResults');
            resultsContainer.innerHTML = "";
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `<p class="text-gray-500 p-2">No users found</p>`;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            results.forEach(user => {
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-2 rounded cursor-pointer hover:bg-gray-100 transition-all";
                div.innerHTML = `
                    <p class="font-medium">${user.username}</p>
                    <p class="text-xs text-gray-500">${user.data.firstName || ''} ${user.data.lastName || ''}</p>
                `;
                div.onclick = () => selectUser(user.username, user.data);
                resultsContainer.appendChild(div);
            });
            
            resultsContainer.classList.remove('hidden');
        });
    });
}

// Select user in manage users modal
function selectUser(username, userData) {
    selectedUser = username;
    
    document.getElementById('selectedUsername').textContent = username;
    document.getElementById('selectedUserBalance').textContent = `${userData.balance || 0} Coins`;
    document.getElementById('selectedUserStatus').textContent = userData.status === "banned" ? "Banned" : "Active";
    document.getElementById('selectedUserJoined').textContent = formatDate(userData.joinedAt);
    document.getElementById('selectedUserEarned').textContent = `${userData.totalEarned || 0} Coins`;
    
    if (userData.status === "banned") {
        document.getElementById('banUserBtn').classList.add('hidden');
        document.getElementById('unbanUserBtn').classList.remove('hidden');
    } else {
        document.getElementById('banUserBtn').classList.remove('hidden');
        document.getElementById('unbanUserBtn').classList.add('hidden');
    }
    
    document.getElementById('selectedUserInfo').classList.remove('hidden');
}

// Ban selected user
function banSelectedUser() {
    if (!selectedUser) return;
    
    if (confirm(`Are you sure you want to ban ${selectedUser}?`)) {
        db.ref('users/' + selectedUser).update({
            status: "banned"
        }).then(() => {
            showNotification(`User ${selectedUser} has been banned`);
            document.getElementById('banUserBtn').classList.add('hidden');
            document.getElementById('unbanUserBtn').classList.remove('hidden');
            document.getElementById('selectedUserStatus').textContent = "Banned";
        });
    }
}

// Unban selected user
function unbanSelectedUser() {
    if (!selectedUser) return;
    
    if (confirm(`Are you sure you want to unban ${selectedUser}?`)) {
        db.ref('users/' + selectedUser).update({
            status: "active"
        }).then(() => {
            showNotification(`User ${selectedUser} has been unbanned`);
            document.getElementById('banUserBtn').classList.remove('hidden');
            document.getElementById('unbanUserBtn').classList.add('hidden');
            document.getElementById('selectedUserStatus').textContent = "Active";
        });
    }
}

// Adjust user balance
function adjustUserBalance() {
    if (!selectedUser) return;
    
    document.getElementById('adjustBalanceUsername').value = selectedUser;
    document.getElementById('balanceAmount').value = "";
    document.getElementById('balanceReason').value = "";
    document.getElementById('adjustBalanceModal').classList.remove('hidden');
    hideManageUsersModal();
}

// Process balance adjustment
function processBalanceAdjustment() {
    const username = document.getElementById('adjustBalanceUsername').value;
    const action = document.getElementById('balanceAction').value;
    const amount = parseInt(document.getElementById('balanceAmount').value);
    const reason = document.getElementById('balanceReason').value.trim();
    
    if (!amount || amount <= 0) {
        showNotification("Please enter a valid amount");
        return;
    }
    
    db.ref('users/' + username).once('value', snap => {
        const user = snap.val();
        if (!user) {
            showNotification("User not found");
            return;
        }
        
        let newBalance = user.balance || 0;
        let adjustmentText = "";
        
        switch(action) {
            case "add":
                newBalance += amount;
                adjustmentText = `Added ${amount} coins to ${username}`;
                break;
            case "subtract":
                newBalance = Math.max(0, newBalance - amount);
                adjustmentText = `Subtracted ${amount} coins from ${username}`;
                break;
            case "set":
                newBalance = amount;
                adjustmentText = `Set balance of ${username} to ${amount} coins`;
                break;
        }
        
        // Update user balance
        db.ref('users/' + username).update({
            balance: newBalance
        }).then(() => {
            // Record the adjustment
            const adjustmentId = Date.now();
            db.ref('balanceAdjustments/' + adjustmentId).set({
                admin: currentUser,
                user: username,
                action: action,
                amount: amount,
                newBalance: newBalance,
                reason: reason,
                timestamp: Date.now()
            });
            
            showNotification(adjustmentText);
            hideAdjustBalanceModal();
        });
    });
}

// Hide adjust balance modal
function hideAdjustBalanceModal() {
    document.getElementById('adjustBalanceModal').classList.add('hidden');
}

// Hide manage users modal
function hideManageUsersModal() {
    document.getElementById('manageUsersModal').classList.add('hidden');
}

// Show pending submissions modal
function showPendingSubmissions() {
    document.getElementById('pendingSubmissionsModal').classList.remove('hidden');
    
    // Load pending submissions
    db.ref('submissions').orderByChild('status').equalTo('pending').once('value', snap => {
        const submissions = snap.val() || {};
        const container = document.getElementById('submissionsList');
        container.innerHTML = "";
        
        if (Object.keys(submissions).length === 0) {
            container.innerHTML = `<p class="text-gray-500 text-center py-4">No pending submissions</p>`;
            return;
        }
        
        // Get all tasks
        db.ref('tasks').once('value', taskSnap => {
            const tasks = taskSnap.val() || {};
            
            Object.keys(submissions).forEach(subId => {
                const submission = submissions[subId];
                const task = tasks[submission.taskId] || { title: "Unknown Task", reward: 0 };
                
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-lg shadow-sm border border-gray-200";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <div>
                            <h4 class="font-medium">${task.title}</h4>
                            <p class="text-xs text-gray-500">Submitted by: ${submission.username}</p>
                        </div>
                        <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Pending</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500 mb-2">
                        <p>${formatDate(submission.submittedAt)}</p>
                        <p>+${task.reward || 0} Coins</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="approveSubmission('${subId}', '${submission.taskId}', '${submission.user}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-1 rounded text-sm transition-all btn-press">
                            Approve
                        </button>
                        <button onclick="rejectSubmission('${subId}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-1 rounded text-sm transition-all btn-press">
                            Reject
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        });
    });
}

// Approve submission
function approveSubmission(submissionId, taskId, userId) {
    db.ref('submissions/' + submissionId).update({
        status: "approved",
        approvedAt: Date.now(),
        approvedBy: currentUser
    }).then(() => {
        // Add coins to user balance
        db.ref('tasks/' + taskId).once('value', taskSnap => {
            const task = taskSnap.val();
            if (task) {
                db.ref('users/' + userId).transaction(user => {
                    if (user) {
                        user.balance = (user.balance || 0) + task.reward;
                        user.totalEarned = (user.totalEarned || 0) + task.reward;
                        
                        // Record today's earnings
                        const todayEarnings = user.todayEarnings || {};
                        todayEarnings[submissionId] = {
                            amount: task.reward,
                            timestamp: Date.now()
                        };
                        user.todayEarnings = todayEarnings;
                    }
                    return user;
                });
            }
        });
        
        showNotification("Submission approved!");
        showPendingSubmissions(); // Refresh the list
    });
}

// Reject submission
function rejectSubmission(submissionId) {
    db.ref('submissions/' + submissionId).update({
        status: "rejected",
        rejectedAt: Date.now(),
        rejectedBy: currentUser
    }).then(() => {
        showNotification("Submission rejected!");
        showPendingSubmissions(); // Refresh the list
    });
}

// Hide pending submissions modal
function hidePendingSubmissionsModal() {
    document.getElementById('pendingSubmissionsModal').classList.add('hidden');
}

// Show withdraw requests modal
function showWithdrawRequests() {
    document.getElementById('withdrawRequestsModal').classList.remove('hidden');
    
    // Load pending withdrawals
    db.ref('withdrawals').orderByChild('status').equalTo('pending').once('value', snap => {
        const withdrawals = snap.val() || {};
        const container = document.getElementById('withdrawRequestsList');
        container.innerHTML = "";
        
        if (Object.keys(withdrawals).length === 0) {
            container.innerHTML = `<p class="text-gray-500 text-center py-4">No pending withdrawal requests</p>`;
            return;
        }
        
        Object.keys(withdrawals).reverse().forEach(withdrawId => {
            const withdrawal = withdrawals[withdrawId];
            
            const div = document.createElement('div');
            div.className = "bg-white p-3 rounded-lg shadow-sm border border-gray-200";
            div.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <div>
                        <h4 class="font-medium">${withdrawal.user}</h4>
                        <p class="text-xs text-gray-500">${formatDate(withdrawal.requestedAt)}</p>
                    </div>
                    <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Pending</span>
                </div>
                <div class="flex justify-between text-sm text-gray-500 mb-2">
                    <p>${withdrawal.method.toUpperCase()}: ${withdrawal.account}</p>
                    <p class="font-bold">${withdrawal.amount} Coins (${withdrawal.amount/10} Taka)</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="approveWithdrawal('${withdrawId}', '${withdrawal.user}', ${withdrawal.amount})" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-1 rounded text-sm transition-all btn-press">
                        Approve
                    </button>
                    <button onclick="rejectWithdrawal('${withdrawId}', '${withdrawal.user}', ${withdrawal.amount})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-1 rounded text-sm transition-all btn-press">
                        Reject
                    </button>
                </div>
            `;
            container.appendChild(div);
        });
    });
}

// Approve withdrawal
function approveWithdrawal(withdrawId, username, amount) {
    db.ref('withdrawals/' + withdrawId).update({
        status: "approved",
        approvedAt: Date.now(),
        approvedBy: currentUser
    }).then(() => {
        showNotification(`Withdrawal of ${amount} coins approved for ${username}`);
        showWithdrawRequests(); // Refresh the list
    });
}

// Reject withdrawal
function rejectWithdrawal(withdrawId, username, amount) {
    // Return coins to user balance
    db.ref('users/' + username).transaction(user => {
        if (user) {
            user.balance = (user.balance || 0) + amount;
            user.totalWithdrawn = (user.totalWithdrawn || 0) - amount;
        }
        return user;
    }).then(() => {
        db.ref('withdrawals/' + withdrawId).update({
            status: "rejected",
            rejectedAt: Date.now(),
            rejectedBy: currentUser
        }).then(() => {
            showNotification(`Withdrawal of ${amount} coins rejected for ${username}`);
            showWithdrawRequests(); // Refresh the list
        });
    });
}

// Hide withdraw requests modal
function hideWithdrawRequestsModal() {
    document.getElementById('withdrawRequestsModal').classList.add('hidden');
}

// Show send notice modal
function showSendNoticeModal() {
    document.getElementById('noticeMessage').value = "";
    document.getElementById('sendNoticeModal').classList.remove('hidden');
}

// Hide send notice modal
function hideSendNoticeModal() {
    document.getElementById('sendNoticeModal').classList.add('hidden');
}

// Send global notice
function sendGlobalNotice() {
    const message = document.getElementById('noticeMessage').value.trim();
    if (!message) {
        showNotification("Please enter a message");
        return;
    }
    
    const noticeId = Date.now();
    db.ref('notifications/' + noticeId).set({
        message: message,
        sentBy: currentUser,
        timestamp: Date.now()
    }).then(() => {
        showNotification("Global notice sent to all users!");
        hideSendNoticeModal();
    });
}

// Update profile section
function updateProfileSection() {
    document.getElementById('profileUsername').textContent = currentUser;
    document.getElementById('totalEarned').textContent = `${userData.totalEarned || 0} Coins`;
    document.getElementById('totalWithdrawn').textContent = `${userData.totalWithdrawn || 0} Coins`;
    document.getElementById('referralEarnings').textContent = `${userData.referralEarnings || 0} Coins`;
    document.getElementById('referralCount').textContent = `${userData.referralCount || 0}`;
    
    // Format join date
    if (userData.joinedAt) {
        const joinDate = new Date(userData.joinedAt);
        document.getElementById('joinDate').textContent = `Joined ${formatRelativeDate(joinDate)}`;
    }
    
    const statusElement = document.getElementById('accountStatus');
    if (userData.status === "banned") {
        statusElement.textContent = "Banned";
        statusElement.className = "font-medium text-red-600";
    } else {
        statusElement.textContent = "Active";
        statusElement.className = "font-medium text-green-600";
    }
}

// Format date
function formatDate(timestamp) {
    if (!timestamp) return "N/A";
    const date = new Date(timestamp);
    return date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// Format relative date (e.g., "2 days ago")
function formatRelativeDate(date) {
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) return "today";
    if (days === 1) return "yesterday";
    if (days < 7) return `${days} days ago`;
    if (days < 30) return `${Math.floor(days/7)} weeks ago`;
    if (days < 365) return `${Math.floor(days/30)} months ago`;
    return `${Math.floor(days/365)} years ago`;
}

// Logout user
function logoutUser() {
    if (confirm("Are you sure you want to logout?")) {
        localStorage.removeItem('loggedUser');
        location.reload();
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
