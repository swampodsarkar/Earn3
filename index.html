<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskEarn - Complete Task & Auto Mining</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Layout */
        body {
            overflow: hidden;
            height: 100vh;
            background-color: #f3f4f6;
        }
        
        /* Custom scrollbar */
        .scrollable {
            scrollbar-width: thin;
            scrollbar-color: #6366f1 #f1f1f1;
        }
        
        .scrollable::-webkit-scrollbar {
            width: 4px;
        }
        
        .scrollable::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .scrollable::-webkit-scrollbar-thumb {
            background-color: #6366f1;
            border-radius: 2px;
        }
        
        /* Button press effect */
        .btn-press:active {
            transform: scale(0.96);
        }
        
        /* Fixed height sections */
        .fixed-section {
            height: calc(100vh - 56px);
            overflow-y: auto;
        }
        
        /* Sidebar styles */
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        /* Header */
        .tg-header {
            background-color: #0088cc;
            color: white;
        }
        
        /* Buttons */
        .tg-button {
            background-color: #0088cc;
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
        }
        
        .tg-button:hover {
            background-color: #0077b3;
        }
        
        /* Cards */
        .tg-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* Overlay for sidebar */
        .overlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        /* Mining animation */
        @keyframes miningPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .mining-active {
            animation: miningPulse 2s infinite;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.7);
        }
        
        /* Progress bar */
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #10b981;
            transition: width 0.3s ease;
        }
        
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal.open .modal-content {
            transform: translateY(0);
        }
        
        /* Ban screen */
        .ban-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            text-align: center;
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .fixed-section {
                height: calc(100vh - 56px);
            }
            
            .mining-section {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="font-sans relative h-screen overflow-hidden">

<!-- Loading Screen -->
<div id="loadingScreen" class="h-screen flex flex-col items-center justify-center text-lg font-bold bg-indigo-600 text-white">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div>
    <p>Loading Application...</p>
</div>

<!-- Ban Screen -->
<div id="banScreen" class="ban-screen hidden">
    <i class="fas fa-ban text-6xl text-red-500 mb-4"></i>
    <h2 class="text-2xl font-bold mb-2">Account Banned</h2>
    <p class="mb-4">Your account has been suspended due to violation of our terms of service.</p>
    <p class="text-gray-400">Please contact support if you believe this is a mistake.</p>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
    <div class="modal-content animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Login to TaskEarn</h3>
            <button onclick="hideLoginModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Username</label>
            <input type="text" id="loginUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter your username">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Password</label>
            <input type="password" id="loginPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter your password">
        </div>
        <button onclick="loginUser()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold transition-all btn-press">
            <i class="fas fa-sign-in-alt mr-2"></i> Login
        </button>
        <div class="mt-4 text-center">
            <p class="text-sm text-gray-600">Don't have an account? <button onclick="showRegisterModal()" class="text-indigo-600 font-medium">Register</button></p>
        </div>
    </div>
</div>

<!-- Register Modal -->
<div id="registerModal" class="modal">
    <div class="modal-content animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Create Account</h3>
            <button onclick="hideRegisterModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Username</label>
            <input type="text" id="registerUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Choose a username">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Password</label>
            <input type="password" id="registerPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Create a password">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Confirm Password</label>
            <input type="password" id="registerConfirmPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Confirm your password">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Referral Code (Optional)</label>
            <input type="text" id="referralCode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter referral code if any">
        </div>
        <button onclick="registerUser()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold transition-all btn-press">
            <i class="fas fa-user-plus mr-2"></i> Register
        </button>
        <div class="mt-4 text-center">
            <p class="text-sm text-gray-600">Already have an account? <button onclick="showLoginModal()" class="text-indigo-600 font-medium">Login</button></p>
        </div>
    </div>
</div>

<!-- Main App Container -->
<div id="appContainer" class="h-full flex flex-col hidden">
    <!-- Header -->
    <div class="tg-header p-3 flex justify-between items-center">
        <button onclick="toggleSidebar()" class="text-white p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition-all btn-press">
            <i class="fas fa-bars"></i>
        </button>
        <h2 class="font-bold text-lg">TaskEarn</h2>
        <div class="flex items-center space-x-2">
            <div id="balanceDisplay" class="text-sm bg-white bg-opacity-20 px-2 py-1 rounded-full">
                <i class="fas fa-coins mr-1"></i> 0 Coins
            </div>
        </div>
    </div>

    <!-- Notification Banner -->
    <div id="notificationBanner" class="hidden bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-3">
        <div class="flex justify-between items-center">
            <p id="notificationText"></p>
            <button onclick="hideNotification()" class="text-blue-700 transition-all hover:scale-110">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Main Content - Fixed Height with Scroll -->
    <div id="mainContent" class="fixed-section p-3 bg-gray-100 scrollable">
        <!-- Balance Card -->
        <div class="tg-card p-4 mb-3 transition-all animate-fadeIn">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-gray-500 text-sm">Total Balance</h3>
                    <p id="mainBalance" class="text-2xl font-bold">0 Coins</p>
                    <p class="text-sm text-gray-500 mt-1">100 Coins = 10 Taka</p>
                </div>
                <button onclick="showWithdrawModal()" class="tg-button flex items-center">
                    <i class="fas fa-wallet mr-2"></i> Withdraw
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="tg-card p-3 transition-all animate-fadeIn">
                <p class="text-gray-500 text-xs">Today's Earnings</p>
                <p id="todayEarnings" class="font-bold">0 Coins</p>
            </div>
            <div class="tg-card p-3 transition-all animate-fadeIn">
                <p class="text-gray-500 text-xs">Total Earnings</p>
                <p id="totalEarningsMini" class="font-bold">0 Coins</p>
            </div>
        </div>

        <!-- Auto Mining Section -->
        <div class="tg-card p-4 mb-3 transition-all animate-fadeIn">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center">
                    <i class="fas fa-microchip text-2xl text-indigo-600 mr-3"></i>
                    <div>
                        <h3 class="font-bold">Auto Coin Mining</h3>
                        <p class="text-xs text-gray-500" id="miningStatus">Not Active</p>
                    </div>
                </div>
                <button id="miningToggle" onclick="toggleMining()" class="bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-sm font-medium transition-all">
                    Start
                </button>
            </div>
            
            <div class="mb-2">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Mining Progress</span>
                    <span id="miningProgressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="miningProgressFill" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mt-3">
                <div class="bg-gray-50 p-2 rounded text-center">
                    <p class="text-xs text-gray-500">Current Rate</p>
                    <p class="font-bold" id="miningRate">5 coins/hr</p>
                </div>
                <div class="bg-gray-50 p-2 rounded text-center">
                    <p class="text-xs text-gray-500">Total Mined</p>
                    <p class="font-bold" id="totalMined">0 coins</p>
                </div>
            </div>
            
            <!-- Deposit to Boost Mining -->
            <div class="mt-4 border-t pt-3">
                <h4 class="font-medium text-sm mb-2">Boost Mining Power</h4>
                <p class="text-xs text-gray-500 mb-2">Deposit 100 coins to activate auto mining</p>
                <button onclick="showDepositModal()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium transition-all btn-press">
                    <i class="fas fa-coins mr-2"></i> Deposit Coins
                </button>
            </div>
        </div>

        <!-- Daily Reward Section -->
        <div class="mb-3 animate-fadeIn">
            <button onclick="claimDaily()" id="dailyButton" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all btn-press">
                <i class="fas fa-gift mr-2"></i> Claim Daily Reward (10 Coins)
            </button>
        </div>

        <!-- Task List -->
        <div class="mb-4">
            <h3 class="font-bold text-lg mb-3 flex items-center animate-fadeIn">
                <i class="fas fa-tasks mr-2 text-indigo-600"></i> Available Tasks
            </h3>
            <div id="tasksContainer" class="space-y-3"></div>
            
            <!-- Empty State -->
            <div id="emptyTasks" class="text-center py-8 text-gray-500 hidden">
                <i class="fas fa-tasks text-4xl mb-3 opacity-30"></i>
                <p>No tasks available at the moment</p>
                <p class="text-sm mt-2">Check back later for new tasks</p>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar -->
<div id="sidebar" class="sidebar fixed top-0 left-0 bottom-0 w-64 bg-white z-50 shadow-xl">
    <!-- Sidebar Header -->
    <div class="tg-header p-4 flex items-center justify-between">
        <h3 class="font-bold text-white">Menu</h3>
        <button onclick="toggleSidebar()" class="text-white p-1 rounded-full hover:bg-white hover:bg-opacity-10 transition-all btn-press">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- User Profile -->
    <div class="p-4 flex items-center border-b border-gray-200">
        <div class="bg-indigo-100 p-3 rounded-full mr-3">
            <i class="fas fa-user text-indigo-600 text-xl"></i>
        </div>
        <div>
            <h3 id="sidebarUsername" class="font-bold">Username</h3>
            <p class="text-xs text-gray-500">@username</p>
        </div>
    </div>
    
    <!-- Sidebar Menu -->
    <div class="py-2">
        <button onclick="showTaskSection()" class="w-full text-left px-4 py-3 flex items-center hover:bg-gray-100 transition-all">
            <i class="fas fa-tasks mr-3 text-indigo-600"></i> Tasks
        </button>
        <button onclick="showHistorySection()" class="w-full text-left px-4 py-3 flex items-center hover:bg-gray-100 transition-all">
            <i class="fas fa-history mr-3 text-indigo-600"></i> History
        </button>
        <button onclick="showMiningSection()" class="w-full text-left px-4 py-3 flex items-center hover:bg-gray-100 transition-all">
            <i class="fas fa-microchip mr-3 text-indigo-600"></i> Mining
        </button>
        <button onclick="showProfileSection()" class="w-full text-left px-4 py-3 flex items-center hover:bg-gray-100 transition-all">
            <i class="fas fa-user mr-3 text-indigo-600"></i> Profile
        </button>
        <button onclick="showReferralSection()" class="w-full text-left px-4 py-3 flex items-center hover:bg-gray-100 transition-all">
            <i class="fas fa-user-plus mr-3 text-indigo-600"></i> Refer & Earn
        </button>
        <button onclick="logoutUser()" class="w-full text-left px-4 py-3 flex items-center hover:bg-gray-100 transition-all text-red-500">
            <i class="fas fa-sign-out-alt mr-3"></i> Logout
        </button>
    </div>
</div>

<!-- Overlay for sidebar -->
<div id="overlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-40" onclick="toggleSidebar()"></div>

<!-- History Section (Hidden by default) -->
<div id="historySection" class="h-full flex flex-col hidden">
    <div class="tg-header p-3 flex items-center shadow-md">
        <button onclick="showTaskSection()" class="text-white p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition-all btn-press mr-2">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="font-bold text-lg text-white">Task History</h2>
    </div>
    
    <div class="fixed-section p-3 bg-gray-100 scrollable">
        <div id="historyContainer" class="space-y-3">
            <!-- History items will be loaded here -->
        </div>
        
        <!-- Empty State -->
        <div id="emptyHistory" class="text-center py-8 text-gray-500 hidden">
            <i class="fas fa-history text-4xl mb-3 opacity-30"></i>
            <p>No task history yet</p>
            <p class="text-sm mt-2">Complete tasks to see them here</p>
        </div>
    </div>
</div>

<!-- Mining Section (Hidden by default) -->
<div id="miningSection" class="h-full flex flex-col hidden">
    <div class="tg-header p-3 flex items-center shadow-md">
        <button onclick="showTaskSection()" class="text-white p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition-all btn-press mr-2">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="font-bold text-lg text-white">Auto Mining</h2>
    </div>
    
    <div class="fixed-section p-3 bg-gray-100 scrollable">
        <div class="tg-card p-4 mb-3 transition-all animate-fadeIn">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center">
                    <i class="fas fa-microchip text-3xl text-indigo-600 mr-3"></i>
                    <div>
                        <h3 class="font-bold text-lg">Auto Coin Mining</h3>
                        <p class="text-sm text-gray-500" id="miningStatusFull">Status: Not Active</p>
                    </div>
                </div>
                <button id="miningToggleFull" onclick="toggleMining()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm font-medium transition-all">
                    Start Mining
                </button>
            </div>
            
            <div class="mining-section flex items-center space-x-4 mb-4">
                <div id="miningVisual" class="bg-indigo-100 p-6 rounded-full text-center transition-all">
                    <i class="fas fa-microchip text-4xl text-indigo-600"></i>
                </div>
                <div class="flex-1">
                    <div class="mb-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>Mining Progress</span>
                            <span id="miningProgressTextFull">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="miningProgressFillFull" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500">Current mining session: <span id="miningSessionTime">0:00</span></p>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="bg-gray-50 p-2 rounded text-center">
                    <p class="text-xs text-gray-500">Current Rate</p>
                    <p class="font-bold" id="miningRateFull">5 coins/hr</p>
                </div>
                <div class="bg-gray-50 p-2 rounded text-center">
                    <p class="text-xs text-gray-500">Today Mined</p>
                    <p class="font-bold" id="todayMined">0 coins</p>
                </div>
                <div class="bg-gray-50 p-2 rounded text-center">
                    <p class="text-xs text-gray-500">Total Mined</p>
                    <p class="font-bold" id="totalMinedFull">0 coins</p>
                </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-4">
                <h4 class="font-bold text-blue-800 mb-2">How Auto Mining Works</h4>
                <ul class="text-sm text-blue-700 space-y-2">
                    <li class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-2 text-blue-500"></i>
                        <span>Deposit 100 coins to activate mining</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-2 text-blue-500"></i>
                        <span>Earn 5 coins per hour passively</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-2 text-blue-500"></i>
                        <span>Higher deposits increase mining rate</span>
                    </li>
                </ul>
            </div>
            
            <button onclick="showDepositModal()" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all btn-press">
                <i class="fas fa-coins mr-2"></i> Deposit Coins to Start Mining
            </button>
        </div>
        
        <div class="tg-card p-4 transition-all animate-fadeIn">
            <h3 class="font-bold mb-3">Mining History</h3>
            <div id="miningHistory" class="space-y-3">
                <!-- Mining history items will be loaded here -->
            </div>
            
            <div id="emptyMiningHistory" class="text-center py-8 text-gray-500 hidden">
                <i class="fas fa-history text-4xl mb-3 opacity-30"></i>
                <p>No mining history yet</p>
                <p class="text-sm mt-2">Start mining to see your earnings here</p>
            </div>
        </div>
    </div>
</div>

<!-- Profile Section (Hidden by default) -->
<div id="profileSection" class="h-full flex flex-col hidden">
    <div class="tg-header p-3 flex items-center shadow-md">
        <button onclick="showTaskSection()" class="text-white p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition-all btn-press mr-2">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="font-bold text-lg text-white">My Profile</h2>
    </div>
    
    <div class="fixed-section p-3 bg-gray-100 scrollable">
        <div class="tg-card p-4 mb-3 transition-all animate-fadeIn">
            <div class="flex items-center space-x-4 mb-4">
                <div class="bg-indigo-100 p-3 rounded-full transition-all hover:bg-indigo-200">
                    <i class="fas fa-user text-indigo-600 text-2xl"></i>
                </div>
                <div>
                    <h3 id="profileUsername" class="font-bold text-lg">@username</h3>
                    <p id="joinDate" class="text-gray-600 text-sm">Joined 2 days ago</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Total Earned</p>
                    <p id="totalEarned" class="font-bold">0 Coins</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Withdrawn</p>
                    <p id="totalWithdrawn" class="font-bold">0 Coins</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Referral Earnings</p>
                    <p id="referralEarnings" class="font-bold">0 Coins</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Referrals</p>
                    <p id="referralCount" class="font-bold">0</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Mining Earnings</p>
                    <p id="miningEarnings" class="font-bold">0 Coins</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg transition-all hover:bg-gray-100">
                    <p class="text-gray-500 text-sm">Mining Power</p>
                    <p id="miningPower" class="font-bold">0%</p>
                </div>
            </div>
        </div>
        
        <div class="tg-card p-4 transition-all animate-fadeIn">
            <h3 class="font-bold mb-3">Account Information</h3>
            <div class="space-y-3">
                <div>
                    <p class="text-gray-500 text-sm">Status</p>
                    <p id="accountStatus" class="font-medium text-green-600">Active</p>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Balance Conversion</p>
                    <p class="font-medium">100 Coins = 10 Taka</p>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Mining Status</p>
                    <p id="profileMiningStatus" class="font-medium">Inactive</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Referral Section (Hidden by default) -->
<div id="referralSection" class="h-full flex flex-col hidden">
    <div class="tg-header p-3 flex items-center shadow-md">
        <button onclick="showTaskSection()" class="text-white p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition-all btn-press mr-2">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="font-bold text-lg text-white">Refer & Earn</h2>
    </div>
    
    <div class="fixed-section p-3 bg-gray-100 scrollable">
        <div class="tg-card p-4 mb-3 transition-all animate-fadeIn">
            <div class="flex items-center mb-3">
                <div class="bg-green-100 p-3 rounded-full mr-3">
                    <i class="fas fa-user-plus text-green-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="font-bold">Earn with Friends</h3>
                    <p class="text-sm text-gray-600">Get 5% of your friends' earnings</p>
                </div>
            </div>
            
            <div class="bg-green-50 border border-green-100 rounded-lg p-3 mb-4">
                <h4 class="font-bold text-green-800 mb-2">How it works</h4>
                <ul class="text-sm text-green-700 space-y-2">
                    <li class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-2 text-green-500"></i>
                        <span>Share your referral link with friends</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-2 text-green-500"></i>
                        <span>They sign up using your link</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle mt-1 mr-2 text-green-500"></i>
                        <span>You earn 5% of all their earnings</span>
                    </li>
                </ul>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Your Referral Link</label>
                <div class="flex items-center bg-gray-100 p-2 rounded">
                    <input type="text" id="referralLink" class="flex-1 bg-transparent border-none text-gray-800" value="https://example.com/earn?ref=username" readonly>
                    <button onclick="copyReferralLink()" class="ml-2 bg-indigo-600 text-white px-3 py-1 rounded text-sm font-bold transition-all hover:bg-indigo-700 btn-press">
                        <i class="fas fa-copy mr-1"></i> Copy
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-gray-50 p-3 rounded-lg text-center">
                    <p class="text-gray-500 text-sm">Total Referrals</p>
                    <p id="sidebarReferralCount" class="font-bold text-lg">0</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg text-center">
                    <p class="text-gray-500 text-sm">Earnings</p>
                    <p id="sidebarReferralEarnings" class="font-bold text-lg">0 Coins</p>
                </div>
            </div>
        </div>
        
        <div class="tg-card p-4 transition-all animate-fadeIn">
            <h3 class="font-bold mb-3">Referral Leaderboard</h3>
            <div id="referralLeaderboard" class="space-y-3">
                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                    <div class="flex items-center">
                        <span class="font-bold mr-2">1.</span>
                        <div class="bg-indigo-100 p-2 rounded-full mr-2">
                            <i class="fas fa-user text-indigo-600"></i>
                        </div>
                        <span>top_referrer</span>
                    </div>
                    <span class="font-bold">50</span>
                </div>
                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                    <div class="flex items-center">
                        <span class="font-bold mr-2">2.</span>
                        <div class="bg-indigo-100 p-2 rounded-full mr-2">
                            <i class="fas fa-user text-indigo-600"></i>
                        </div>
                        <span>second_referrer</span>
                    </div>
                    <span class="font-bold">30</span>
                </div>
                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                    <div class="flex items-center">
                        <span class="font-bold mr-2">3.</span>
                        <div class="bg-indigo-100 p-2 rounded-full mr-2">
                            <i class="fas fa-user text-indigo-600"></i>
                        </div>
                        <span>third_referrer</span>
                    </div>
                    <span class="font-bold">20</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Withdraw Modal -->
<div id="withdrawModal" class="modal">
    <div class="modal-content animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Withdraw Coins</h3>
            <button onclick="hideWithdrawModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Amount (Min 100 Coins = 10 Taka)</label>
            <input type="number" id="withdrawAmount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter amount">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Withdrawal Method</label>
            <select id="withdrawMethod" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                <option value="nagad">Nagad</option>
                <option value="bkash">bKash</option>
                <option value="rocket">Rocket</option>
                <option value="binance">Binance</option>
                <option value="bitget">Bitget</option>
            </select>
        </div>
        <div id="accountNumberField" class="mb-4">
            <label class="block text-gray-700 mb-2">Account Number</label>
            <input type="text" id="withdrawAccount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter account number">
        </div>
        <button onclick="submitWithdraw()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold transition-all btn-press">
            Submit Withdraw Request
        </button>
    </div>
</div>

<!-- Deposit Modal -->
<div id="depositModal" class="modal">
    <div class="modal-content animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Deposit Coins</h3>
            <button onclick="hideDepositModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Amount (Min 100 Coins)</label>
            <input type="number" id="depositAmount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter amount to deposit">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Payment Method</label>
            <select id="depositMethod" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                <option value="nagad">Nagad</option>
                <option value="bkash">bKash</option>
                <option value="rocket">Rocket</option>
            </select>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Send Payment To</label>
            <div class="bg-gray-100 p-3 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium">Nagad:</span>
                    <span class="font-bold">017XXXXXXXX</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="font-medium">bKash:</span>
                    <span class="font-bold">017XXXXXXXX</span>
                </div>
                <div class="flex items-center justify-between mt-2">
                    <span class="font-medium">Rocket:</span>
                    <span class="font-bold">017XXXXXXXX</span>
                </div>
            </div>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Transaction ID</label>
            <input type="text" id="transactionId" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter transaction ID">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Your Account Number</label>
            <input type="text" id="senderAccount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="Enter your account number">
        </div>
        <button onclick="submitDeposit()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold transition-all btn-press">
            <i class="fas fa-coins mr-2"></i> Submit Deposit Request
        </button>
    </div>
</div>

<!-- QR Code Modal -->
<div id="qrModal" class="modal">
    <div class="modal-content animate-fadeIn">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Scan QR Code to Pay</h3>
            <button onclick="hideQrModal()" class="text-gray-500 hover:text-gray-700 transition-all btn-press">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="text-center mb-4">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://example.com/pay" alt="QR Code" class="mx-auto mb-3">
            <p class="text-sm text-gray-600">Scan this QR code with your mobile payment app</p>
        </div>
        <div class="bg-gray-100 p-3 rounded-lg mb-4">
            <p class="text-center font-bold">017XXXXXXXX</p>
            <p class="text-center text-sm text-gray-600" id="qrPaymentMethod">Nagad</p>
        </div>
        <button onclick="copyPaymentNumber()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-medium transition-all btn-press">
            <i class="fas fa-copy mr-2"></i> Copy Number
        </button>
    </div>
</div>

<!-- Firebase configuration -->
<script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDX7Z8o5xVJa8cSHvaurZg4FkJvN8mJuto",
    authDomain: "free-fire-kingdom.firebaseapp.com",
    databaseURL: "https://free-fire-kingdom-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "free-fire-kingdom",
    storageBucket: "free-fire-kingdom.appspot.com",
    messagingSenderId: "889375613179",
    appId: "1:889375613179:web:b36bd72dd208b101e0d05e",
    measurementId: "G-0EWSZ3SFX1"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let userData = {};
let miningInterval = null;
let miningSessionStart = 0;
let miningProgress = 0;
let miningSessionSeconds = 0;

// Initialize the app
function initApp() {
    // Check if user is logged in
    const savedUser = localStorage.getItem('loggedUser');
    if (savedUser) {
        currentUser = savedUser;
        loadUser();
    } else {
        // Show login modal if not logged in
        setTimeout(() => {
            showLoginModal();
        }, 500);
    }
    
    // Listen for global notifications
    db.ref('notifications').limitToLast(1).on('child_added', snapshot => {
        const notification = snapshot.val();
        showNotification(notification.message);
    });
    
    // Handle withdraw method change
    document.getElementById('withdrawMethod').addEventListener('change', function() {
        updateWithdrawMethodFields(this.value);
    });
    
    // Handle deposit method change
    document.getElementById('depositMethod').addEventListener('change', function() {
        updateQrCode(this.value);
    });
}

// Show login modal
function showLoginModal() {
    document.getElementById('loginModal').classList.add('open');
}

// Hide login modal
function hideLoginModal() {
    document.getElementById('loginModal').classList.remove('open');
}

// Show register modal
function showRegisterModal() {
    hideLoginModal();
    document.getElementById('registerModal').classList.add('open');
}

// Hide register modal
function hideRegisterModal() {
    document.getElementById('registerModal').classList.remove('open');
}

// Login user
function loginUser() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!username || !password) {
        showNotification("Please enter both username and password");
        return;
    }
    
    // In a real app, you would verify credentials with Firebase Auth
    // For demo, we'll just check if the user exists in the database
    db.ref('users/' + username).once('value').then(snapshot => {
        if (snapshot.exists()) {
            const user = snapshot.val();
            
            // Check if account is banned
            if (user.status === "banned") {
                showNotification("Your account has been banned. Contact support.");
                document.getElementById('banScreen').classList.remove('hidden');
                return;
            }
            
            // In a real app, verify password with Firebase Auth
            // For demo, we'll just log them in
            currentUser = username;
            localStorage.setItem('loggedUser', currentUser);
            hideLoginModal();
            loadUser();
            showNotification("Login successful!");
        } else {
            showNotification("User not found. Please register.");
        }
    });
}

// Register new user
function registerUser() {
    const username = document.getElementById('registerUsername').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;
    const referralCode = document.getElementById('referralCode').value.trim();
    
    if (!username || !password || !confirmPassword) {
        showNotification("Please fill all required fields");
        return;
    }
    
    if (password !== confirmPassword) {
        showNotification("Passwords do not match");
        return;
    }
    
    if (username.length < 4) {
        showNotification("Username must be at least 4 characters");
        return;
    }
    
    if (password.length < 6) {
        showNotification("Password must be at least 6 characters");
        return;
    }
    
    // Check if username already exists
    db.ref('users/' + username).once('value').then(snapshot => {
        if (snapshot.exists()) {
            showNotification("Username already taken");
        } else {
            // Check referral code if provided
            let referredBy = null;
            if (referralCode) {
                referredBy = referralCode;
            }
            
            // Create new user
            const userData = { 
                balance: 10, // Starting bonus
                totalEarned: 10,
                totalWithdrawn: 0,
                referralEarnings: 0,
                referralCount: 0,
                referredBy: referredBy,
                lastClaim: 0,
                status: "active",
                joinedAt: Date.now(),
                miningDeposit: 0,
                miningActive: false,
                miningEarnings: 0,
                miningRate: 5, // Base rate 5 coins per hour
                miningLastUpdate: 0
            };
            
            db.ref('users/' + username).set(userData).then(() => {
                // If referred, update referrer's data
                if (referredBy) {
                    db.ref('users/' + referredBy).once('value', referrerSnap => {
                        if (referrerSnap.exists()) {
                            const referrerData = referrerSnap.val();
                            db.ref('users/' + referredBy).update({
                                referralCount: (referrerData.referralCount || 0) + 1
                            });
                        }
                    });
                }
                
                currentUser = username;
                localStorage.setItem('loggedUser', currentUser);
                hideRegisterModal();
                loadUser();
                showNotification("Registration successful! You received 10 bonus coins.");
            });
        }
    });
}

// Load user data
function loadUser() {
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('appContainer').classList.remove('hidden');
    showTaskSection();
    
    // Update UI with user data
    document.getElementById('sidebarUsername').textContent = currentUser;
    
    // Set referral link
    document.getElementById('referralLink').value = `https://example.com/earn?ref=${currentUser}`;
    
    // Listen for user data changes
    db.ref('users/' + currentUser).on('value', snapshot => {
        userData = snapshot.val() || {};
        
        // Check if user is banned
        if (userData.status === "banned") {
            document.getElementById('banScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');
            document.getElementById('miningSection').classList.add('hidden');
            document.getElementById('profileSection').classList.add('hidden');
            document.getElementById('referralSection').classList.add('hidden');
            return;
        }
        
        // Update balance displays
        document.getElementById('balanceDisplay').innerHTML = `
            <i class="fas fa-coins mr-1"></i> ${userData.balance || 0} Coins
        `;
        document.getElementById('mainBalance').textContent = `${userData.balance || 0} Coins`;
        document.getElementById('totalEarningsMini').textContent = `${userData.totalEarned || 0} Coins`;
        
        // Calculate today's earnings (since midnight)
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayEarnings = userData.todayEarnings || {};
        let todayTotal = 0;
        
        Object.keys(todayEarnings).forEach(key => {
            if (todayEarnings[key].timestamp >= today.getTime()) {
                todayTotal += todayEarnings[key].amount || 0;
            }
        });
        
        document.getElementById('todayEarnings').textContent = `${todayTotal} Coins`;
        
        // Update mining status
        updateMiningUI();
        
        // Update profile section if visible
        if (!document.getElementById('profileSection').classList.contains('hidden')) {
            updateProfileSection();
        }
        
        // Update referral section if visible
        if (!document.getElementById('referralSection').classList.contains('hidden')) {
            updateReferralSection();
        }
        
        // Update mining section if visible
        if (!document.getElementById('miningSection').classList.contains('hidden')) {
            updateMiningSection();
        }
    });
    
    loadTasks();
    loadTaskHistory();
    loadMiningHistory();
    
    // Auto approve pending tasks after 10 minutes
    checkPendingTasks();
}

// Update withdraw method fields based on selection
function updateWithdrawMethodFields(method) {
    const accountField = document.getElementById('accountNumberField');
    
    if (method === 'binance' || method === 'bitget') {
        accountField.querySelector('label').textContent = 'Wallet Address';
        accountField.querySelector('input').placeholder = 'Enter wallet address';
    } else {
        accountField.querySelector('label').textContent = 'Account Number';
        accountField.querySelector('input').placeholder = 'Enter account number';
    }
}

// Update QR code based on payment method
function updateQrCode(method) {
    const qrMethodElement = document.getElementById('qrPaymentMethod');
    let number = '';
    
    switch(method) {
        case 'nagad':
            number = '017XXXXXXXX';
            qrMethodElement.textContent = 'Nagad';
            break;
        case 'bkash':
            number = '017XXXXXXXX';
            qrMethodElement.textContent = 'bKash';
            break;
        case 'rocket':
            number = '017XXXXXXXX';
            qrMethodElement.textContent = 'Rocket';
            break;
    }
    
    // Update the QR code image src
    document.querySelector('#qrModal img').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${number}`;
}

// Show deposit modal
function showDepositModal() {
    document.getElementById('depositAmount').value = "";
    document.getElementById('transactionId').value = "";
    document.getElementById('senderAccount').value = "";
    document.getElementById('depositModal').classList.add('open');
}

// Hide deposit modal
function hideDepositModal() {
    document.getElementById('depositModal').classList.remove('open');
}

// Show QR code modal
function showQrModal() {
    document.getElementById('qrModal').classList.add('open');
}

// Hide QR code modal
function hideQrModal() {
    document.getElementById('qrModal').classList.remove('open');
}

// Show withdraw modal
function showWithdrawModal() {
    const minWithdraw = 100;
    if ((userData.balance || 0) < minWithdraw) {
        showNotification(`Minimum withdrawal is ${minWithdraw} coins (10 Taka)`);
        return;
    }
    
    document.getElementById('withdrawAmount').value = "";
    document.getElementById('withdrawAccount').value = "";
    document.getElementById('withdrawModal').classList.add('open');
}

// Hide withdraw modal
function hideWithdrawModal() {
    document.getElementById('withdrawModal').classList.remove('open');
}

// Update mining UI based on user data
function updateMiningUI() {
    const miningToggle = document.getElementById('miningToggle');
    const miningToggleFull = document.getElementById('miningToggleFull');
    const miningVisual = document.getElementById('miningVisual');
    const miningStatus = document.getElementById('miningStatus');
    const miningStatusFull = document.getElementById('miningStatusFull');
    
    if (userData.miningDeposit >= 100) {
        // User has deposited enough to mine
        if (userData.miningActive) {
            // Mining is active
            miningToggle.textContent = 'Stop';
            miningToggle.className = 'bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium transition-all';
            miningToggleFull.textContent = 'Stop Mining';
            miningToggleFull.className = 'bg-red-100 text-red-800 px-4 py-2 rounded-full text-sm font-medium transition-all';
            miningVisual.classList.add('mining-active');
            miningStatus.textContent = 'Active';
            miningStatusFull.textContent = 'Status: Active';
            
            // Start mining timer if not already running
            if (!miningInterval) {
                startMining();
            }
        } else {
            // Mining is inactive but can be started
            miningToggle.textContent = 'Start';
            miningToggle.className = 'bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium transition-all';
            miningToggleFull.textContent = 'Start Mining';
            miningToggleFull.className = 'bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-medium transition-all';
            miningVisual.classList.remove('mining-active');
            miningStatus.textContent = 'Ready';
            miningStatusFull.textContent = 'Status: Ready';
            
            // Stop mining timer if running
            if (miningInterval) {
                stopMining();
            }
        }
    } else {
        // User hasn't deposited enough to mine
        miningToggle.textContent = 'Deposit';
        miningToggle.className = 'bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-sm font-medium transition-all';
        miningToggleFull.textContent = 'Deposit';
        miningToggleFull.className = 'bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm font-medium transition-all';
        miningVisual.classList.remove('mining-active');
        miningStatus.textContent = 'Deposit 100+ coins';
        miningStatusFull.textContent = 'Status: Deposit Required';
        
        // Stop mining timer if running
        if (miningInterval) {
            stopMining();
        }
    }
    
    // Update mining rate display
    const miningRate = userData.miningRate || 5;
    document.getElementById('miningRate').textContent = `${miningRate} coins/hr`;
    document.getElementById('miningRateFull').textContent = `${miningRate} coins/hr`;
    
    // Update total mined display
    document.getElementById('totalMined').textContent = `${userData.miningEarnings || 0} coins`;
    document.getElementById('totalMinedFull').textContent = `${userData.miningEarnings || 0} coins`;
    document.getElementById('miningEarnings').textContent = `${userData.miningEarnings || 0} coins`;
    
    // Update mining power (based on deposit amount)
    const miningPower = Math.min(Math.floor((userData.miningDeposit || 0) / 100) * 10, 100);
    document.getElementById('miningPower').textContent = `${miningPower}%`;
    
    // Update profile mining status
    if (userData.miningActive) {
        document.getElementById('profileMiningStatus').textContent = 'Active';
        document.getElementById('profileMiningStatus').className = 'font-medium text-green-600';
    } else {
        document.getElementById('profileMiningStatus').textContent = 'Inactive';
        document.getElementById('profileMiningStatus').className = 'font-medium text-gray-600';
    }
}

// Start mining process
function startMining() {
    if (miningInterval) {
        clearInterval(miningInterval);
    }
    
    miningSessionStart = Date.now();
    miningSessionSeconds = 0;
    miningProgress = 0;
    
    // Update mining progress every second
    miningInterval = setInterval(() => {
        miningSessionSeconds++;
        
        // Calculate progress (1 hour = 100%)
        miningProgress = (miningSessionSeconds / 3600) * 100;
        if (miningProgress > 100) miningProgress = 100;
        
        // Update UI
        document.getElementById('miningProgressFill').style.width = `${miningProgress}%`;
        document.getElementById('miningProgressText').textContent = `${Math.floor(miningProgress)}%`;
        document.getElementById('miningProgressFillFull').style.width = `${miningProgress}%`;
        document.getElementById('miningProgressTextFull').textContent = `${Math.floor(miningProgress)}%`;
        
        // Format session time
        const hours = Math.floor(miningSessionSeconds / 3600);
        const minutes = Math.floor((miningSessionSeconds % 3600) / 60);
        const seconds = miningSessionSeconds % 60;
        document.getElementById('miningSessionTime').textContent = 
            `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Check if we've completed an hour
        if (miningSessionSeconds >= 3600) {
            completeMiningCycle();
            miningSessionSeconds = 0;
            miningProgress = 0;
        }
    }, 1000);
    
    // Update database
    db.ref('users/' + currentUser).update({
        miningActive: true,
        miningLastUpdate: Date.now()
    });
}

// Stop mining process
function stopMining() {
    if (miningInterval) {
        clearInterval(miningInterval);
        miningInterval = null;
        
        // Calculate partial earnings if any
        if (miningSessionSeconds > 0) {
            const miningRate = userData.miningRate || 5;
            const partialEarnings = (miningSessionSeconds / 3600) * miningRate;
            
            if (partialEarnings > 0) {
                db.ref('users/' + currentUser).transaction(user => {
                    if (user) {
                        user.balance = (user.balance || 0) + partialEarnings;
                        user.totalEarned = (user.totalEarned || 0) + partialEarnings;
                        user.miningEarnings = (user.miningEarnings || 0) + partialEarnings;
                        
                        // Record today's earnings
                        const todayEarnings = user.todayEarnings || {};
                        todayEarnings[`mining_${Date.now()}`] = {
                            amount: partialEarnings,
                            timestamp: Date.now()
                        };
                        user.todayEarnings = todayEarnings;
                        
                        // Record mining history
                        const miningHistoryRef = db.ref(`miningHistory/${currentUser}`).push();
                        miningHistoryRef.set({
                            amount: partialEarnings,
                            timestamp: Date.now(),
                            sessionDuration: miningSessionSeconds
                        });
                    }
                    return user;
                });
            }
        }
        
        // Reset session
        miningSessionStart = 0;
        miningSessionSeconds = 0;
        miningProgress = 0;
        
        // Update database
        db.ref('users/' + currentUser).update({
            miningActive: false
        });
    }
}

// Complete a full mining cycle (1 hour)
function completeMiningCycle() {
    const miningRate = userData.miningRate || 5;
    
    db.ref('users/' + currentUser).transaction(user => {
        if (user) {
            user.balance = (user.balance || 0) + miningRate;
            user.totalEarned = (user.totalEarned || 0) + miningRate;
            user.miningEarnings = (user.miningEarnings || 0) + miningRate;
            
            // Record today's earnings
            const todayEarnings = user.todayEarnings || {};
            todayEarnings[`mining_${Date.now()}`] = {
                amount: miningRate,
                timestamp: Date.now()
            };
            user.todayEarnings = todayEarnings;
            
            // Record mining history
            const miningHistoryRef = db.ref(`miningHistory/${currentUser}`).push();
            miningHistoryRef.set({
                amount: miningRate,
                timestamp: Date.now(),
                sessionDuration: 3600
            });
            
            // If referred, give bonus to referrer
            if (user.referredBy) {
                const referralBonus = Math.floor(miningRate * 0.05); // 5% commission
                db.ref('users/' + user.referredBy).transaction(referrer => {
                    if (referrer) {
                        referrer.balance = (referrer.balance || 0) + referralBonus;
                        referrer.referralEarnings = (referrer.referralEarnings || 0) + referralBonus;
                        referrer.totalEarned = (referrer.totalEarned || 0) + referralBonus;
                    }
                    return referrer;
                });
            }
        }
        return user;
    });
    
    showNotification(`Mining complete! You earned ${miningRate} coins.`);
}

// Toggle mining state
function toggleMining() {
    if (userData.miningDeposit < 100) {
        showDepositModal();
        return;
    }
    
    if (userData.miningActive) {
        stopMining();
    } else {
        startMining();
    }
}

// Load available tasks
function loadTasks() {
    db.ref('tasks').orderByChild('active').equalTo(true).once('value', snap => {
        const tasks = snap.val() || {};
        const container = document.getElementById('tasksContainer');
        const emptyState = document.getElementById('emptyTasks');
        
        container.innerHTML = "";
        
        if (Object.keys(tasks).length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        Object.keys(tasks).forEach(taskId => {
            const task = tasks[taskId];
            const div = document.createElement('div');
            div.className = "tg-card p-4 rounded-lg transition-all animate-fadeIn";
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-lg">${task.title}</h4>
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">+${task.reward} Coins</span>
                </div>
                <p class="text-gray-600 text-sm mb-3">${task.description || 'Complete this task to earn coins'}</p>
                ${task.link ? `<a href="${task.link}" target="_blank" class="text-blue-500 text-sm block mb-3"><i class="fas fa-external-link-alt mr-1"></i> Task Link</a>` : ''}
                <button onclick="submitTask('${taskId}')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-medium transition-all btn-press">
                    <i class="fas fa-check-circle mr-2"></i> Complete Task
                </button>
            `;
            container.appendChild(div);
        });
    });
}

// Submit a task for review
function submitTask(taskId) {
    const submissionId = Date.now();
    db.ref('submissions/' + submissionId).set({
        user: currentUser,
        taskId: taskId,
        status: "pending",
        submittedAt: Date.now(),
        username: currentUser
    }).then(() => {
        showNotification("Task submitted for review!");
        
        // Check if user was referred and update referrer's earnings
        if (userData.referredBy) {
            db.ref('tasks/' + taskId).once('value', taskSnap => {
                const task = taskSnap.val();
                if (task) {
                    const referralBonus = Math.floor(task.reward * 0.05); // 5% commission
                    db.ref('users/' + userData.referredBy).transaction(user => {
                        if (user) {
                            user.balance = (user.balance || 0) + referralBonus;
                            user.referralEarnings = (user.referralEarnings || 0) + referralBonus;
                            user.totalEarned = (user.totalEarned || 0) + referralBonus;
                        }
                        return user;
                    });
                }
            });
        }
    });
}

// Check for pending tasks that need auto approval
function checkPendingTasks() {
    if (!currentUser) return;
    
    db.ref('submissions').orderByChild('user').equalTo(currentUser).once('value', snap => {
        const submissions = snap.val() || {};
        const now = Date.now();
        
        Object.keys(submissions).forEach(subId => {
            const submission = submissions[subId];
            if (submission.status === "pending" && (now - submission.submittedAt) > 600000) { // 10 minutes
                // Auto approve after 10 minutes
                db.ref('submissions/' + subId).update({ status: "approved" });
                
                // Add coins to user balance
                db.ref('tasks/' + submission.taskId).once('value', taskSnap => {
                    const task = taskSnap.val();
                    if (task) {
                        db.ref('users/' + currentUser).transaction(user => {
                            if (user) {
                                user.balance = (user.balance || 0) + task.reward;
                                user.totalEarned = (user.totalEarned || 0) + task.reward;
                                
                                // Record today's earnings
                                const todayEarnings = user.todayEarnings || {};
                                todayEarnings[subId] = {
                                    amount: task.reward,
                                    timestamp: now
                                };
                                user.todayEarnings = todayEarnings;
                            }
                            return user;
                        });
                    }
                });
            }
        });
    });
}

// Load task history
function loadTaskHistory() {
    db.ref('submissions').orderByChild('user').equalTo(currentUser).limitToLast(20).once('value', snap => {
        const submissions = snap.val() || {};
        const container = document.getElementById('historyContainer');
        const emptyState = document.getElementById('emptyHistory');
        
        container.innerHTML = "";
        
        if (Object.keys(submissions).length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        // Get task names first
        db.ref('tasks').once('value', taskSnap => {
            const allTasks = taskSnap.val() || {};
            
            Object.keys(submissions).reverse().forEach(subId => {
                const submission = submissions[subId];
                const task = allTasks[submission.taskId] || { title: "Unknown Task", reward: 0 };
                
                const div = document.createElement('div');
                div.className = "tg-card p-4 rounded-lg transition-all animate-fadeIn";
                
                let statusBadge = "";
                if (submission.status === "approved") {
                    statusBadge = `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Approved</span>`;
                } else if (submission.status === "rejected") {
                    statusBadge = `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">Rejected</span>`;
                } else {
                    statusBadge = `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Pending</span>`;
                }
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-medium">${task.title}</h4>
                        ${statusBadge}
                    </div>
                    <div class="flex justify-between text-sm text-gray-500">
                        <p>${formatDate(submission.submittedAt)}</p>
                        <p>+${task.reward || 0} Coins</p>
                    </div>
                `;
                container.appendChild(div);
            });
        });
    });
}

// Load mining history
function loadMiningHistory() {
    db.ref('miningHistory/' + currentUser).orderByChild('timestamp').limitToLast(10).once('value', snap => {
        const history = snap.val() || {};
        const container = document.getElementById('miningHistory');
        const emptyState = document.getElementById('emptyMiningHistory');
        
        container.innerHTML = "";
        
        if (Object.keys(history).length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        // Convert to array and reverse to show newest first
        const historyArray = Object.keys(history).map(key => ({ id: key, ...history[key] }));
        historyArray.reverse().forEach(item => {
            const div = document.createElement('div');
            div.className = "tg-card p-4 rounded-lg transition-all animate-fadeIn";
            
            const hours = Math.floor(item.sessionDuration / 3600);
            const minutes = Math.floor((item.sessionDuration % 3600) / 60);
            const seconds = item.sessionDuration % 60;
            const duration = `${hours > 0 ? hours + 'h ' : ''}${minutes > 0 ? minutes + 'm ' : ''}${seconds}s`;
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <h4 class="font-medium">Mining Session</h4>
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Completed</span>
                </div>
                <div class="flex justify-between text-sm text-gray-500">
                    <p>${formatDate(item.timestamp)}</p>
                    <p>+${item.amount || 0} Coins</p>
                </div>
                <div class="text-xs text-gray-400 mt-1">Duration: ${duration}</div>
            `;
            container.appendChild(div);
        });
    });
}

// Claim daily reward
function claimDaily() {
    const now = Date.now();
    const dailyButton = document.getElementById('dailyButton');
    
    // Disable button to prevent multiple clicks
    dailyButton.disabled = true;
    dailyButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Processing...`;
    
    db.ref('users/' + currentUser).once('value', snap => {
        const data = snap.val();
        const lastClaim = data.lastClaim || 0;
        const timeSinceLastClaim = now - lastClaim;
        
        if (timeSinceLastClaim < 86400000) {
            const hoursLeft = Math.floor((86400000 - timeSinceLastClaim) / 3600000);
            showNotification(`Come back in ${hoursLeft} hours to claim your next reward!`);
            dailyButton.disabled = false;
            dailyButton.innerHTML = `<i class="fas fa-clock mr-2"></i> Already Claimed Today`;
            return;
        }
        
        // Update user data
        const reward = 10; // Daily reward amount
        db.ref('users/' + currentUser).transaction(user => {
            if (user) {
                user.balance = (user.balance || 0) + reward;
                user.totalEarned = (user.totalEarned || 0) + reward;
                user.lastClaim = now;
                
                // Record today's earnings
                const todayEarnings = user.todayEarnings || {};
                todayEarnings[`daily_${now}`] = {
                    amount: reward,
                    timestamp: now
                };
                user.todayEarnings = todayEarnings;
                
                // If referred, give bonus to referrer
                if (user.referredBy) {
                    const referralBonus = Math.floor(reward * 0.05); // 5% commission
                    db.ref('users/' + user.referredBy).transaction(referrer => {
                        if (referrer) {
                            referrer.balance = (referrer.balance || 0) + referralBonus;
                            referrer.referralEarnings = (referrer.referralEarnings || 0) + referralBonus;
                            referrer.totalEarned = (referrer.totalEarned || 0) + referralBonus;
                        }
                        return referrer;
                    });
                }
            }
            return user;
        }).then(() => {
            showNotification(`Daily reward of ${reward} coins claimed!`);
            dailyButton.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Claimed Today`;
            
            // Re-enable button after 24 hours
            setTimeout(() => {
                dailyButton.disabled = false;
                dailyButton.innerHTML = `<i class="fas fa-gift mr-2"></i> Claim Daily Reward (10 Coins)`;
            }, 86400000);
        });
    });
}

// Submit deposit request
function submitDeposit() {
    const amount = parseInt(document.getElementById('depositAmount').value);
    const method = document.getElementById('depositMethod').value;
    const transactionId = document.getElementById('transactionId').value.trim();
    const senderAccount = document.getElementById('senderAccount').value.trim();
    const minDeposit = 100;
    
    if (!amount || amount < minDeposit) {
        showNotification(`Minimum deposit is ${minDeposit} coins`);
        return;
    }
    
    if (!transactionId) {
        showNotification("Please enter your transaction ID");
        return;
    }
    
    if (!senderAccount) {
        showNotification("Please enter your account number");
        return;
    }
    
    const depositId = Date.now();
    db.ref('deposits/' + depositId).set({
        user: currentUser,
        amount: amount,
        method: method,
        transactionId: transactionId,
        senderAccount: senderAccount,
        status: "pending",
        requestedAt: Date.now()
    }).then(() => {
        showNotification(`Deposit request submitted for ${amount} coins. Please wait for approval.`);
        hideDepositModal();
    });
}

// Submit withdraw request
function submitWithdraw() {
    const amount = parseInt(document.getElementById('withdrawAmount').value);
    const method = document.getElementById('withdrawMethod').value;
    const account = document.getElementById('withdrawAccount').value.trim();
    const minWithdraw = 100;
    
    if (!amount || amount < minWithdraw) {
        showNotification(`Minimum withdrawal is ${minWithdraw} coins (10 Taka)`);
        return;
    }
    
    if (amount > (userData.balance || 0)) {
        showNotification("Insufficient balance");
        return;
    }
    
    if (!account) {
        const fieldName = (method === 'binance' || method === 'bitget') ? 'wallet address' : 'account number';
        showNotification(`Please enter a valid ${fieldName}`);
        return;
    }
    
    const withdrawId = Date.now();
    db.ref('withdrawals/' + withdrawId).set({
        user: currentUser,
        amount: amount,
        method: method,
        account: account,
        status: "pending",
        requestedAt: Date.now()
    }).then(() => {
        // Deduct from user balance immediately
        db.ref('users/' + currentUser).update({
            balance: (userData.balance || 0) - amount,
            totalWithdrawn: (userData.totalWithdrawn || 0) + amount
        });
        
        showNotification(`Withdrawal request submitted for ${amount} coins (${amount/10} Taka)`);
        hideWithdrawModal();
        
        // Open payment method URL if available
        openPaymentMethod(method);
    });
}

// Copy payment number
function copyPaymentNumber() {
    const method = document.getElementById('depositMethod').value;
    let number = '';
    
    switch(method) {
        case 'nagad':
            number = '017XXXXXXXX';
            break;
        case 'bkash':
            number = '017XXXXXXXX';
            break;
        case 'rocket':
            number = '017XXXXXXXX';
            break;
    }
    
    navigator.clipboard.writeText(number).then(() => {
        showNotification("Payment number copied to clipboard!");
    });
}

// Open payment method URL
function openPaymentMethod(method) {
    let url = '';
    switch(method) {
        case 'nagad':
            url = 'https://nagad.com.bd';
            break;
        case 'bkash':
            url = 'https://www.bkash.com';
            break;
        case 'rocket':
            url = 'https://www.dutchbanglabank.com/rocket/rocket.html';
            break;
        case 'binance':
            url = 'https://www.binance.com';
            break;
        case 'bitget':
            url = 'https://www.bitget.com';
            break;
    }
    
    if (url) {
        window.open(url, '_blank');
    }
}

// Copy referral link
function copyReferralLink() {
    const linkInput = document.getElementById('referralLink');
    linkInput.select();
    document.execCommand('copy');
    
    showNotification("Referral link copied to clipboard!");
}

// Show notification
function showNotification(message) {
    const banner = document.getElementById('notificationBanner');
    document.getElementById('notificationText').textContent = message;
    banner.classList.remove('hidden');
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        banner.classList.add('hidden');
    }, 5000);
}

// Hide notification
function hideNotification() {
    document.getElementById('notificationBanner').classList.add('hidden');
}

// Toggle sidebar
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('open');
}

// Show task section (main view)
function showTaskSection() {
    document.getElementById('appContainer').classList.remove('hidden');
    document.getElementById('historySection').classList.add('hidden');
    document.getElementById('miningSection').classList.add('hidden');
    document.getElementById('profileSection').classList.add('hidden');
    document.getElementById('referralSection').classList.add('hidden');
    toggleSidebar();
}

// Show history section
function showHistorySection() {
    document.getElementById('appContainer').classList.add('hidden');
    document.getElementById('historySection').classList.remove('hidden');
    document.getElementById('miningSection').classList.add('hidden');
    document.getElementById('profileSection').classList.add('hidden');
    document.getElementById('referralSection').classList.add('hidden');
    loadTaskHistory();
    toggleSidebar();
}

// Show mining section
function showMiningSection() {
    document.getElementById('appContainer').classList.add('hidden');
    document.getElementById('miningSection').classList.remove('hidden');
    document.getElementById('historySection').classList.add('hidden');
    document.getElementById('profileSection').classList.add('hidden');
    document.getElementById('referralSection').classList.add('hidden');
    updateMiningSection();
    toggleSidebar();
}

// Update mining section
function updateMiningSection() {
    // Calculate today's mined coins
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const miningHistory = userData.miningHistory || {};
    let todayMined = 0;
    
    Object.keys(miningHistory).forEach(key => {
        if (miningHistory[key].timestamp >= today.getTime()) {
            todayMined += miningHistory[key].amount || 0;
        }
    });
    
    document.getElementById('todayMined').textContent = `${todayMined} coins`;
}

// Show profile section
function showProfileSection() {
    document.getElementById('appContainer').classList.add('hidden');
    document.getElementById('profileSection').classList.remove('hidden');
    document.getElementById('historySection').classList.add('hidden');
    document.getElementById('miningSection').classList.add('hidden');
    document.getElementById('referralSection').classList.add('hidden');
    updateProfileSection();
    toggleSidebar();
}

// Show referral section
function showReferralSection() {
    document.getElementById('appContainer').classList.add('hidden');
    document.getElementById('referralSection').classList.remove('hidden');
    document.getElementById('historySection').classList.add('hidden');
    document.getElementById('miningSection').classList.add('hidden');
    document.getElementById('profileSection').classList.add('hidden');
    updateReferralSection();
    toggleSidebar();
}

// Update profile section
function updateProfileSection() {
    document.getElementById('profileUsername').textContent = currentUser;
    document.getElementById('totalEarned').textContent = `${userData.totalEarned || 0} Coins`;
    document.getElementById('totalWithdrawn').textContent = `${userData.totalWithdrawn || 0} Coins`;
    document.getElementById('referralEarnings').textContent = `${userData.referralEarnings || 0} Coins`;
    document.getElementById('referralCount').textContent = `${userData.referralCount || 0}`;
    document.getElementById('miningEarnings').textContent = `${userData.miningEarnings || 0} Coins`;
    
    // Calculate mining power based on deposit amount
    const miningPower = Math.min(Math.floor((userData.miningDeposit || 0) / 100) * 10, 100);
    document.getElementById('miningPower').textContent = `${miningPower}%`;
    
    // Format join date
    if (userData.joinedAt) {
        const joinDate = new Date(userData.joinedAt);
        document.getElementById('joinDate').textContent = `Joined ${formatRelativeDate(joinDate)}`;
    }
    
    const statusElement = document.getElementById('accountStatus');
    if (userData.status === "banned") {
        statusElement.textContent = "Banned";
        statusElement.className = "font-medium text-red-600";
    } else {
        statusElement.textContent = "Active";
        statusElement.className = "font-medium text-green-600";
    }
    
    // Update mining status
    if (userData.miningActive) {
        document.getElementById('profileMiningStatus').textContent = "Active";
        document.getElementById('profileMiningStatus').className = "font-medium text-green-600";
    } else {
        document.getElementById('profileMiningStatus').textContent = "Inactive";
        document.getElementById('profileMiningStatus').className = "font-medium text-gray-600";
    }
}

// Update referral section
function updateReferralSection() {
    document.getElementById('sidebarReferralCount').textContent = userData.referralCount || 0;
    document.getElementById('sidebarReferralEarnings').textContent = `${userData.referralEarnings || 0} Coins`;
}

// Format date
function formatDate(timestamp) {
    if (!timestamp) return "N/A";
    const date = new Date(timestamp);
    return date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// Format relative date (e.g., "2 days ago")
function formatRelativeDate(date) {
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) return "today";
    if (days === 1) return "yesterday";
    if (days < 7) return `${days} days ago`;
    if (days < 30) return `${Math.floor(days/7)} weeks ago`;
    if (days < 365) return `${Math.floor(days/30)} months ago`;
    return `${Math.floor(days/365)} years ago`;
}

// Logout user
function logoutUser() {
    if (confirm("Are you sure you want to logout?")) {
        localStorage.removeItem('loggedUser');
        location.reload();
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
